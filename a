using DynatraceProblemUpdater.Models.Dynatrace;
using DynatraceProblemUpdater.Models.ProblemsDB;
using Microsoft.Data.SqlClient;

namespace DynatraceProblemUpdater.Data.Repositories
{
    public class DynatraceProblemRepository
    {
        private readonly string _connectionString;

        public DynatraceProblemRepository(string connectionString)
        {
            _connectionString = connectionString;
        }

        /// <summary>
        /// Obtiene la lista de ProblemId de todos los problemas con estado 'open' filtrados por Environment.
        /// </summary>
        public async Task<List<string>> GetOpenProblemIdsAsync(string environment)
        {
            var problemIds = new List<string>();

            using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync();

            const string query = @"SELECT ProblemId FROM DynatraceProblems 
                                   WHERE Status = 'open' AND Environment = @Environment";

            using var command = new SqlCommand(query, connection);
            command.Parameters.AddWithValue("@Environment", environment);

            using var reader = await command.ExecuteReaderAsync();

            while (await reader.ReadAsync())
            {
                problemIds.Add(reader.GetString(0));
            }

            return problemIds;
        }

        public async Task InsertProblemsBatchAsync(List<DBProblem> problems)
        {
            if (problems == null || problems.Count == 0) return;

            using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync();
            using var transaction = await connection.BeginTransactionAsync();

            try
            {
                const string query = @"
                    MERGE INTO dbo.DynatraceProblems AS target
                    USING (
                        VALUES (
                            @ProblemId, @SeverityLevel, @Status, @Title, @DisplayId, @StartTime, @EndTime, @ImpactLevel,
                            @ClusterName, @ClusterUid, @NamespaceName, @AffectedEntities, @EntityTags, @EvidenceDetails,
                            @ImpactAnalysis, @ImpactedEntities, @ManagementZones, @ProblemFilters, @RecentComments,
                            @RootCauseEntity, @Environment, @Tenant, @ShortDescription, @AffectedCI, @IncidentServiceNow,
                            @Jurisdiction)) 
                        AS source (ProblemId, SeverityLevel, Status, Title, DisplayId, StartTime, EndTime, ImpactLevel,
                            ClusterName, ClusterUid, NamespaceName, AffectedEntities, EntityTags, EvidenceDetails,
                            ImpactAnalysis, ImpactedEntities, ManagementZones, ProblemFilters, RecentComments,
                            RootCauseEntity, Environment, Tenant, ShortDescription, AffectedCI, IncidentServiceNow,
                            Jurisdiction)
                    ON  target.ProblemId   = source.ProblemId AND target.Environment = source.Environment AND target.Tenant = source.Tenant
                    WHEN MATCHED THEN
                        UPDATE SET
                            SeverityLevel     = source.SeverityLevel,
                            Status            = source.Status,
                            Title             = source.Title,
                            DisplayId         = source.DisplayId,
                            StartTime         = source.StartTime,
                            EndTime           = source.EndTime,
                            ImpactLevel       = source.ImpactLevel,
                            ClusterName       = source.ClusterName,
                            ClusterUid        = source.ClusterUid,
                            NamespaceName     = source.NamespaceName,
                            AffectedEntities  = source.AffectedEntities,
                            EntityTags        = source.EntityTags,
                            EvidenceDetails   = source.EvidenceDetails,
                            ImpactAnalysis    = source.ImpactAnalysis,
                            ImpactedEntities  = source.ImpactedEntities,
                            ManagementZones   = source.ManagementZones,
                            ProblemFilters    = source.ProblemFilters,
                            RecentComments    = source.RecentComments,
                            RootCauseEntity   = source.RootCauseEntity,

                        -- Jurisdiction: actualizar solo si viene con valor
                        Jurisdiction = CASE
                            WHEN source.Jurisdiction IS NOT NULL AND LTRIM(RTRIM(source.Jurisdiction)) <> ''
                                 THEN source.Jurisdiction
                            ELSE target.Jurisdiction
                        END,

                        -- ShortDescription: corregir si quedó nula/'Unknown'/'TCS'/'No TCS'
                        ShortDescription = CASE
                            WHEN target.ShortDescription IS NULL
                              OR target.ShortDescription IN ('Unknown','TCS','No TCS')
                                 THEN source.ShortDescription
                            ELSE target.ShortDescription
                        END,

                        AffectedCI = CASE
                            WHEN target.AffectedCI IS NULL OR target.AffectedCI = '[]'
                                 THEN source.AffectedCI
                            ELSE target.AffectedCI
                        END,
                        IncidentServiceNow = CASE 
                            WHEN target.IncidentServiceNow IS NULL OR target.IncidentServiceNow = '{}' 
                            THEN source.IncidentServiceNow 
                            ELSE target.IncidentServiceNow 
                        END
                    WHEN NOT MATCHED THEN
                    INSERT (
                        ProblemId, SeverityLevel, Status, Title, DisplayId, StartTime, EndTime, ImpactLevel,
                        ClusterName, ClusterUid, NamespaceName, AffectedEntities, EntityTags, EvidenceDetails,
                        ImpactAnalysis, ImpactedEntities, ManagementZones, ProblemFilters, RecentComments,
                        RootCauseEntity, Environment, Tenant, ShortDescription, AffectedCI, IncidentServiceNow,
                        Jurisdiction
                    )
                    VALUES (
                        source.ProblemId, source.SeverityLevel, source.Status, source.Title, source.DisplayId,
                        source.StartTime, source.EndTime, source.ImpactLevel, source.ClusterName, source.ClusterUid,
                        source.NamespaceName, source.AffectedEntities, source.EntityTags, source.EvidenceDetails,
                        source.ImpactAnalysis, source.ImpactedEntities, source.ManagementZones, source.ProblemFilters,
                        source.RecentComments, source.RootCauseEntity, source.Environment, source.Tenant,
                        source.ShortDescription, source.AffectedCI, source.IncidentServiceNow, source.Jurisdiction
                    );
                ";

                foreach (var problem in problems)
                {
                    using var command = new SqlCommand(query, connection, (SqlTransaction)transaction);
                    command.Parameters.AddWithValue("@ProblemId", problem.ProblemId);
                    command.Parameters.AddWithValue("@SeverityLevel", problem.SeverityLevel);
                    command.Parameters.AddWithValue("@Status", problem.Status);
                    command.Parameters.AddWithValue("@Title", problem.Title);
                    command.Parameters.AddWithValue("@DisplayId", problem.DisplayId);
                    command.Parameters.AddWithValue("@StartTime", problem.StartTime);
                    command.Parameters.AddWithValue("@EndTime", problem.EndTime ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactLevel", problem.ImpactLevel);
                    command.Parameters.AddWithValue("@ClusterName", problem.ClusterName ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ClusterUid", problem.ClusterUid ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@NamespaceName", problem.NamespaceName ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@AffectedEntities", problem.AffectedEntities ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@EntityTags", problem.EntityTags ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@EvidenceDetails", problem.EvidenceDetails ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactAnalysis", problem.ImpactAnalysis ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactedEntities", problem.ImpactedEntities ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ManagementZones", problem.ManagementZones ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ProblemFilters", problem.ProblemFilters ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@RecentComments", problem.RecentComments ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@RootCauseEntity", problem.RootCauseEntity ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@Environment", problem.Environment);
                    command.Parameters.AddWithValue("@Tenant", problem.Tenant);
                    command.Parameters.AddWithValue("@ShortDescription", problem.ShortDescription ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@AffectedCI", problem.AffectedCI ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@IncidentServiceNow", problem.IncidentServiceNow ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@Jurisdiction", problem.Jurisdiction ?? (object)DBNull.Value);

                    await command.ExecuteNonQueryAsync();
                }

                await transaction.CommitAsync();
            }
            catch (Exception)
            {
                await transaction.RollbackAsync();
                throw;
            }
        }

        /// <summary>
        /// Actualiza múltiples problemas en la base de datos en una sola transacción.
        /// </summary>
        /// 
        public async Task UpdateProblemsBatchAsync(List<DBProblem> problems)
        {
            if (problems == null || problems.Count == 0) return;

            using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync();
            using var transaction = await connection.BeginTransactionAsync();

            try
            {
                const string query = @"
                    UPDATE DynatraceProblems 
                    SET SeverityLevel = @SeverityLevel, 
                        Status = @Status, 
                        Title = @Title, 
                        DisplayId = @DisplayId, 
                        StartTime = @StartTime, 
                        EndTime = @EndTime, 
                        ImpactLevel = @ImpactLevel, 
                        ClusterName = @ClusterName, 
                        ClusterUid = @ClusterUid, 
                        NamespaceName = @NamespaceName, 
                        AffectedEntities = @AffectedEntities, 
                        EntityTags = @EntityTags, 
                        EvidenceDetails = @EvidenceDetails, 
                        ImpactAnalysis = @ImpactAnalysis, 
                        ImpactedEntities = @ImpactedEntities, 
                        ManagementZones = @ManagementZones, 
                        ProblemFilters = @ProblemFilters, 
                        RecentComments = @RecentComments, 
                        RootCauseEntity = @RootCauseEntity,
                        Jurisdiction = @Jurisdiction,

                        -- ✅ Actualizar AffectedCI solo si es NULL o []
                        AffectedCI = CASE 
                                        WHEN AffectedCI IS NULL OR AffectedCI = '[]' THEN @AffectedCI 
                                        ELSE AffectedCI 
                                    END,

                        -- ✅ Actualizar ShortDescription solo si es NULL o 'Unknown'
                        ShortDescription = CASE 
                                            WHEN ShortDescription IS NULL OR ShortDescription = 'Unknown' THEN @ShortDescription 
                                            ELSE ShortDescription 
                                        END,

                          -- ✅ Actualizar IncidentServiceNow solo si es NULL o '{}'
                        IncidentServiceNow = CASE 
                                                WHEN IncidentServiceNow IS NULL OR IncidentServiceNow = '{}' THEN @IncidentServiceNow 
                                                ELSE IncidentServiceNow 
                                            END

                    WHERE ProblemId = @ProblemId 
                    AND Environment = @Environment 
                    AND Tenant = @Tenant";

                foreach (var problem in problems)
                {
                    using var command = new SqlCommand(query, connection, (SqlTransaction)transaction);
                    command.Parameters.AddWithValue("@ProblemId", problem.ProblemId);
                    command.Parameters.AddWithValue("@SeverityLevel", problem.SeverityLevel);
                    command.Parameters.AddWithValue("@Status", problem.Status);
                    command.Parameters.AddWithValue("@Title", problem.Title);
                    command.Parameters.AddWithValue("@DisplayId", problem.DisplayId);
                    command.Parameters.AddWithValue("@StartTime", problem.StartTime);
                    command.Parameters.AddWithValue("@EndTime", problem.EndTime ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactLevel", problem.ImpactLevel);
                    command.Parameters.AddWithValue("@ClusterName", problem.ClusterName ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ClusterUid", problem.ClusterUid ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@NamespaceName", problem.NamespaceName ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@AffectedEntities", problem.AffectedEntities ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@EntityTags", problem.EntityTags ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@EvidenceDetails", problem.EvidenceDetails ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactAnalysis", problem.ImpactAnalysis ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ImpactedEntities", problem.ImpactedEntities ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ManagementZones", problem.ManagementZones ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@ProblemFilters", problem.ProblemFilters ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@RecentComments", problem.RecentComments ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@RootCauseEntity", problem.RootCauseEntity ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@Environment", problem.Environment);
                    command.Parameters.AddWithValue("@Tenant", problem.Tenant);
                    command.Parameters.AddWithValue("@ShortDescription", problem.ShortDescription ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@AffectedCI", problem.AffectedCI ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@IncidentServiceNow", problem.IncidentServiceNow ?? (object)DBNull.Value);
                    command.Parameters.AddWithValue("@Jurisdiction", problem.Jurisdiction ?? (object)DBNull.Value);
                 
                    await command.ExecuteNonQueryAsync();
                }

                await transaction.CommitAsync();
            }
            catch (Exception)
            {
                await transaction.RollbackAsync();
                throw;
            }
        }
    }
}
