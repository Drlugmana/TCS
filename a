private async Task UpdateDatabaseInRealTime(APIToken token, CancellationToken stoppingToken)
{
    var openDynatraceProblems = await FetchOpenProblemIdsAsync(token, stoppingToken);
    var openProblemIds = await _problemRepository.GetOpenProblemIdsAsync(token.Environment);

    var newProblemsIds = openDynatraceProblems.Except(openProblemIds).ToList();
    var closedProblemsIds = openProblemIds.Except(openDynatraceProblems).ToList();

    // üîÑ NUEVO: OPEN existentes que deben refrescarse
    var refreshOpenProblemsIds = openDynatraceProblems.Intersect(openProblemIds).ToList();

    List<DBProblem> newProblems =
        await FetchProblemByIdsAsync(newProblemsIds, token, stoppingToken);

    List<DBProblem> closedProblems =
        await FetchProblemByIdsAsync(closedProblemsIds, token, stoppingToken);

    // üîÑ NUEVO: refresco de comentarios / evidencia
    List<DBProblem> refreshedOpenProblems =
        await FetchProblemByIdsAsync(refreshOpenProblemsIds, token, stoppingToken);

    await UpdateProblemDatabase(
        newProblems,
        closedProblems,
        refreshedOpenProblems
    );
}


-------

private async Task UpdateProblemDatabase(
    List<DBProblem> newProblems,
    List<DBProblem> closedProblems,
    List<DBProblem> refreshedOpenProblems
)
{
    try
    {
        if (newProblems.Count > 0)
        {
            _logger.LogInformation("üü¢ Insertando {Count} nuevos problemas en la BD...", newProblems.Count);
            await _problemRepository.InsertProblemsBatchAsync(newProblems);
            _logger.LogInformation("‚úÖ {Count} problemas insertados correctamente.", newProblems.Count);
        }

        if (closedProblems.Count > 0)
        {
            _logger.LogInformation("üü° Actualizando {Count} problemas cerrados en la BD...", closedProblems.Count);
            await _problemRepository.UpdateProblemsBatchAsync(closedProblems);
            _logger.LogInformation("‚úÖ {Count} problemas cerrados actualizados correctamente.", closedProblems.Count);
        }

        // üîÑ NUEVO: refresco de alertas abiertas
        if (refreshedOpenProblems.Count > 0)
        {
            _logger.LogInformation(
                "üîÑ Actualizando {Count} alertas abiertas (comentarios / evidencia)...",
                refreshedOpenProblems.Count
            );

            await _problemRepository.UpdateProblemsBatchAsync(refreshedOpenProblems);

            _logger.LogInformation(
                "‚úÖ {Count} alertas abiertas refrescadas correctamente.",
                refreshedOpenProblems.Count
            );
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "‚ùå Error al procesar los problemas de Dynatrace.");
    }
}