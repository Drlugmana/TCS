using DynatraceProblemUpdater.Models.Dynatrace;
using Formatting = Newtonsoft.Json.Formatting;
using Newtonsoft.Json;
using DynatraceProblemUpdater.Data.Sources.CmdbServers;

namespace DynatraceProblemUpdater.Models.ProblemsDB
{
    public class DBProblem
    {
        // Campos de API Dynatrace V2 por defecto
        public string ProblemId { get; set; } = string.Empty;
        public string SeverityLevel { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string DisplayId { get; set; } = string.Empty;
        public DateTime StartTime { get; set; }
        public DateTime? EndTime { get; set; }
        public string ImpactLevel { get; set; } = string.Empty;
        // Campos de API Dynatrace V2 que se almacenaran como string
        public string? ClusterName { get; set; }
        public string? ClusterUid { get; set; }
        public string? NamespaceName { get; set; }
        public string? AffectedEntities { get; set; }
        public string? EntityTags { get; set; }
        public string? EvidenceDetails { get; set; }
        public string? ImpactAnalysis { get; set; }
        public string? ImpactedEntities { get; set; }
        public string? ManagementZones { get; set; }
        public string? ProblemFilters { get; set; }
        public string? RecentComments { get; set; }
        public string? RootCauseEntity { get; set; }
        // Campos agregados para trazabilidad de tenant y ambiente
        public string Environment { get; set; } = string.Empty;
        public string Tenant { get; set; } = string.Empty;
        // Campo generado por ML.NET para categorzar los problemas
        public string? ShortDescription { get; set; }
        // Campo agregado para determinar los CI afectados
        public string? AffectedCI { get; set; }
        // Campo agregado para determinar si el problema genero un ticket en service now 
        public string? IncidentServiceNow { get; set; }
        public string? Jurisdiction { get; set; }


        public DBProblem(DynatraceProblem problem, string environment, string tenant, string shortDescription, string affectedCi, string jurisdiction)
        {
            ProblemId = problem.ProblemId ;
            SeverityLevel = problem.SeverityLevel ;
            Status = problem.Status ;
            Title = problem.Title ;
            DisplayId = problem.DisplayId ;
            StartTime = DateTimeOffset.FromUnixTimeMilliseconds(problem.StartTime).UtcDateTime.AddHours(-5);
            EndTime = problem.EndTime == -1 ? (DateTime?)null : DateTimeOffset.FromUnixTimeMilliseconds(problem.EndTime).UtcDateTime.AddHours(-5);
            ImpactLevel = problem.ImpactLevel ;
            ClusterName = JsonConvert.SerializeObject(problem?.ClusterName, Formatting.Indented);
            ClusterUid = JsonConvert.SerializeObject(problem?.ClusterUid, Formatting.Indented);
            NamespaceName = JsonConvert.SerializeObject(problem?.NamespaceName, Formatting.Indented);
            AffectedEntities = JsonConvert.SerializeObject(problem?.AffectedEntities, Formatting.Indented);
            EntityTags = JsonConvert.SerializeObject(problem?.EntityTags, Formatting.Indented);
            EvidenceDetails = JsonConvert.SerializeObject(problem?.EvidenceDetails, Formatting.Indented);
            ImpactAnalysis = JsonConvert.SerializeObject(problem?.ImpactAnalysis, Formatting.Indented);
            ImpactedEntities = JsonConvert.SerializeObject(problem?.ImpactedEntities, Formatting.Indented);
            ManagementZones = JsonConvert.SerializeObject(problem?.ManagementZones, Formatting.Indented);
            ProblemFilters = JsonConvert.SerializeObject(problem?.ProblemFilters, Formatting.Indented);
            RecentComments = JsonConvert.SerializeObject(problem?.RecentComments, Formatting.Indented);
            RootCauseEntity = JsonConvert.SerializeObject(problem?.RootCauseEntity, Formatting.Indented);
           
            Environment = environment;
            Tenant = tenant;
            ShortDescription = shortDescription;
            AffectedCI = affectedCi;
            IncidentServiceNow = null;
            Jurisdiction = jurisdiction;

        }
    }
}
