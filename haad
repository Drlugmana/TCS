import React, { useEffect, useMemo, useState } from "react";
import ProblemCard from "../components/ProblemCard";
import { fetchAllProblems } from "../api/problems";

export default function OtrosPage() {
  const [username, setUsername] = useState("");
  const [loading, setLoading] = useState(false);

  const [envFilter, setEnvFilter] = useState(null);
  const [statusChip, setStatusChip] = useState(null);

  const [all, setAll] = useState([]);

  async function load() {
    setLoading(true);
    try {
      // ✅ último día + NO TCS
      const data = await fetchAllProblems({
        tcsFilter: false,
        recentDays: 1,
        pageSize: 500,
        maxPages: 40,
      });
      setAll(data);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    const t = setInterval(load, 30000);
    return () => clearInterval(t);
  }, []);

  const stats = useMemo(() => {
    const prod = all.filter((x) => String(x.environment).toUpperCase().includes("PRODUCTIVO"));
    const nprod = all.filter((x) => String(x.environment).toUpperCase().includes("NO PRODUCTIVO") || String(x.environment).toUpperCase().includes("NOPRODUCTIVO"));

    const open = all.filter((x) => x.status === "OPEN");
    const closed = all.filter((x) => x.status === "CLOSED");

    return {
      prodCount: prod.length,
      nprodCount: nprod.length,
      openCount: open.length,
      closedCount: closed.length,
    };
  }, [all]);

  const visible = useMemo(() => {
    let arr = [...all];

    if (envFilter) {
      const want = envFilter.toUpperCase();
      arr = arr.filter((x) => String(x.environment || "").toUpperCase().includes(want));
    }

    if (statusChip) {
      arr = arr.filter((x) => String(x.status || "").toUpperCase() === statusChip);
    }

    arr.sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());
    return arr;
  }, [all, envFilter, statusChip]);

  return (
    <div>
      <h2 style={{ textAlign: "center" }}>Problemas Otros ({all.length})</h2>

      <div style={{ textAlign: "center", marginBottom: "10px" }}>
        Usuario:{" "}
        <input value={username} onChange={(e) => setUsername(e.target.value)} />
      </div>

      <div style={{ display: "flex", gap: "10px", justifyContent: "center", marginBottom: "10px", flexWrap: "wrap" }}>
        <button onClick={() => setEnvFilter("Productivo")}>Productivo ({stats.prodCount})</button>
        <button onClick={() => setEnvFilter("No Productivo")}>No Productivo ({stats.nprodCount})</button>
        <button onClick={() => setStatusChip("OPEN")}>Abiertas ({stats.openCount})</button>
        <button onClick={() => setStatusChip("CLOSED")}>Cerradas ({stats.closedCount})</button>
        <button onClick={() => { setEnvFilter(null); setStatusChip(null); }}>Todos</button>
      </div>

      {loading && <div style={{ textAlign: "center" }}>Cargando problemas...</div>}

      {visible.map((p) => (
        <ProblemCard key={p.problemId || p.displayId || p.id} problem={p} username={username} />
      ))}
    </div>
  );
}

----

import React, { useEffect, useMemo, useState } from "react";
import ProblemCard from "../components/ProblemCard";
import { fetchAllProblems } from "../api/problems";

export default function TcsPage() {
  const [username, setUsername] = useState("");
  const [loading, setLoading] = useState(false);

  // filtros de chips
  const [envFilter, setEnvFilter] = useState(null); // "Productivo" | "No Productivo" | null
  const [statusChip, setStatusChip] = useState(null); // "OPEN" | "CLOSED" | null

  const [all, setAll] = useState([]);

  async function load() {
    setLoading(true);
    try {
      // ✅ último día + TCS
      const data = await fetchAllProblems({
        tcsFilter: true,
        recentDays: 1,
        pageSize: 500,
        maxPages: 40,
      });
      setAll(data);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // refresco “tiempo real” (cada 30s) para que aparezcan nuevas OPEN
    const t = setInterval(load, 30000);
    return () => clearInterval(t);
  }, []);

  const stats = useMemo(() => {
    const prod = all.filter((x) => String(x.environment).toUpperCase().includes("PRODUCTIVO"));
    const nprod = all.filter((x) => String(x.environment).toUpperCase().includes("NO PRODUCTIVO") || String(x.environment).toUpperCase().includes("NOPRODUCTIVO"));

    const open = all.filter((x) => x.status === "OPEN");   // ✅
    const closed = all.filter((x) => x.status === "CLOSED");

    return {
      prodCount: prod.length,
      nprodCount: nprod.length,
      openCount: open.length,
      closedCount: closed.length,
    };
  }, [all]);

  const visible = useMemo(() => {
    let arr = [...all];

    if (envFilter) {
      const want = envFilter.toUpperCase();
      arr = arr.filter((x) => String(x.environment || "").toUpperCase().includes(want));
    }

    if (statusChip) {
      arr = arr.filter((x) => String(x.status || "").toUpperCase() === statusChip);
    }

    // siempre recientes primero
    arr.sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());
    return arr;
  }, [all, envFilter, statusChip]);

  return (
    <div>
      <h2 style={{ textAlign: "center" }}>Problemas TCS ({all.length})</h2>

      <div style={{ textAlign: "center", marginBottom: "10px" }}>
        Usuario:{" "}
        <input value={username} onChange={(e) => setUsername(e.target.value)} />
      </div>

      {/* CHIPS (MISMA IDEA QUE TU UI) */}
      <div style={{ display: "flex", gap: "10px", justifyContent: "center", marginBottom: "10px", flexWrap: "wrap" }}>
        <button onClick={() => setEnvFilter("Productivo")}>Productivo ({stats.prodCount})</button>
        <button onClick={() => setEnvFilter("No Productivo")}>No Productivo ({stats.nprodCount})</button>
        <button onClick={() => setStatusChip("OPEN")}>Abiertas ({stats.openCount})</button>
        <button onClick={() => setStatusChip("CLOSED")}>Cerradas ({stats.closedCount})</button>
        <button onClick={() => { setEnvFilter(null); setStatusChip(null); }}>Todos</button>
      </div>

      {loading && <div style={{ textAlign: "center" }}>Cargando problemas...</div>}

      {visible.map((p) => (
        <ProblemCard key={p.problemId || p.displayId || p.id} problem={p} username={username} />
      ))}
    </div>
  );
}

-----

import React, { useEffect, useMemo, useState } from "react";
import ProblemCard from "../components/ProblemCard";
import { fetchAllProblems } from "../api/problems";

export default function TcsPage() {
  const [username, setUsername] = useState("");
  const [loading, setLoading] = useState(false);

  // filtros de chips
  const [envFilter, setEnvFilter] = useState(null); // "Productivo" | "No Productivo" | null
  const [statusChip, setStatusChip] = useState(null); // "OPEN" | "CLOSED" | null

  const [all, setAll] = useState([]);

  async function load() {
    setLoading(true);
    try {
      // ✅ último día + TCS
      const data = await fetchAllProblems({
        tcsFilter: true,
        recentDays: 1,
        pageSize: 500,
        maxPages: 40,
      });
      setAll(data);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // refresco “tiempo real” (cada 30s) para que aparezcan nuevas OPEN
    const t = setInterval(load, 30000);
    return () => clearInterval(t);
  }, []);

  const stats = useMemo(() => {
    const prod = all.filter((x) => String(x.environment).toUpperCase().includes("PRODUCTIVO"));
    const nprod = all.filter((x) => String(x.environment).toUpperCase().includes("NO PRODUCTIVO") || String(x.environment).toUpperCase().includes("NOPRODUCTIVO"));

    const open = all.filter((x) => x.status === "OPEN");   // ✅
    const closed = all.filter((x) => x.status === "CLOSED");

    return {
      prodCount: prod.length,
      nprodCount: nprod.length,
      openCount: open.length,
      closedCount: closed.length,
    };
  }, [all]);

  const visible = useMemo(() => {
    let arr = [...all];

    if (envFilter) {
      const want = envFilter.toUpperCase();
      arr = arr.filter((x) => String(x.environment || "").toUpperCase().includes(want));
    }

    if (statusChip) {
      arr = arr.filter((x) => String(x.status || "").toUpperCase() === statusChip);
    }

    // siempre recientes primero
    arr.sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime());
    return arr;
  }, [all, envFilter, statusChip]);

  return (
    <div>
      <h2 style={{ textAlign: "center" }}>Problemas TCS ({all.length})</h2>

      <div style={{ textAlign: "center", marginBottom: "10px" }}>
        Usuario:{" "}
        <input value={username} onChange={(e) => setUsername(e.target.value)} />
      </div>

      {/* CHIPS (MISMA IDEA QUE TU UI) */}
      <div style={{ display: "flex", gap: "10px", justifyContent: "center", marginBottom: "10px", flexWrap: "wrap" }}>
        <button onClick={() => setEnvFilter("Productivo")}>Productivo ({stats.prodCount})</button>
        <button onClick={() => setEnvFilter("No Productivo")}>No Productivo ({stats.nprodCount})</button>
        <button onClick={() => setStatusChip("OPEN")}>Abiertas ({stats.openCount})</button>
        <button onClick={() => setStatusChip("CLOSED")}>Cerradas ({stats.closedCount})</button>
        <button onClick={() => { setEnvFilter(null); setStatusChip(null); }}>Todos</button>
      </div>

      {loading && <div style={{ textAlign: "center" }}>Cargando problemas...</div>}

      {visible.map((p) => (
        <ProblemCard key={p.problemId || p.displayId || p.id} problem={p} username={username} />
      ))}
    </div>
  );
}