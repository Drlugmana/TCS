// src/api/Problems.js

const API_BASE =
  import.meta?.env?.VITE_API_BASE_URL ||
  import.meta?.env?.VITE_API ||
  window?.API_BASE_URL ||
  "https://localhost:44334"; // <-- cambia si tu backend estÃ¡ en otro host/puerto

function buildUrl(path, params = {}) {
  const url = new URL(path, API_BASE);
  Object.entries(params).forEach(([k, v]) => {
    if (v !== undefined && v !== null && String(v).trim() !== "") {
      url.searchParams.set(k, String(v));
    }
  });
  return url.toString();
}

async function safeReadJson(res) {
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await res.json();

  const txt = await res.text();
  try {
    return JSON.parse(txt);
  } catch {
    return { data: [], raw: txt };
  }
}

/**
 * GET /api/Problems/latest
 * Debe devolver MISMA estructura que /api/Problems:
 * {
 *   totalRecords,
 *   totalPages,
 *   pageNumber,
 *   pageSize,
 *   data: [...]
 * }
 */
export async function getLatestProblems({ pageNumber = 1, pageSize = 1000, jurisdiction } = {}) {
  const url = buildUrl("/api/Problems/latest", { pageNumber, pageSize, jurisdiction });

  const res = await fetch(url, {
    method: "GET",
    headers: {
      Accept: "application/json, text/plain, */*",
    },
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Error ${res.status} llamando ${url}\n${txt}`);
  }

  const json = await safeReadJson(res);

  if (json && Array.isArray(json.data)) return json;

  // fallback si viniera un array directo
  if (Array.isArray(json)) {
    return {
      totalRecords: json.length,
      totalPages: 1,
      pageNumber,
      pageSize,
      data: json,
    };
  }

  return {
    totalRecords: 0,
    totalPages: 0,
    pageNumber,
    pageSize,
    data: [],
  };
}