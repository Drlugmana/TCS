// ===============================
// src/api/problems.js
// ===============================

// 0) CONFIG OPCIONAL FECHA
// Si pones una fecha "YYYY-MM-DD" fuerza modo día puntual.
// Si lo dejas en null => SIN límite por fecha (histórico completo).
export const ONLY_DATE = null;

// 1) BASE DE LA API (desde .env)
const BASE = (import.meta.env.VITE_API_URL || "").replace(/\/+$/, "");
if (!BASE) throw new Error("Falta VITE_API_URL en .env (ej: https://xxxxx.brs.devtunnels.ms)");
const API = `${BASE}/api/Problems`;

// 2) Normalizador robusto
function normalize(list) {
  if (!Array.isArray(list)) return [];

  return list.map((p) => {
    // start / end (acepta nombres diversos)
    const startRaw =
      p.startTime ??
      p.startTimeUtc ??
      p.StartTime ??
      p.StartTimeUtc ??
      p.start_date ??
      null;

    const endRaw =
      p.endTime ??
      p.endTimeUtc ??
      p.EndTime ??
      p.EndTimeUtc ??
      p.end_date ??
      null;

    // jurisdicción
    const jurisRaw =
      p.jurisdiction?.label ??
      p.jurisdiction?.name ??
      p.jurisdiction?.Jurisdiction ??
      p.Jurisdiction ??
      p.jurisdiction ??
      p.label ??
      p.Label ??
      "";

    const juris = typeof jurisRaw === "string" ? jurisRaw.trim().toUpperCase() : "";
    const isTcs =
      p.jurisdiction?.isTcs ??
      (typeof juris === "string" ? (juris === "TCS" ? true : false) : false) ??
      false;

    // ids/títulos
    const problemId = p.problemId ?? p.displayId ?? p.id ?? "";
    const title = p.title ?? p.shortDescription ?? "(sin título)";

    // otros campos usados por la UI
    const severityLevel = p.severityLevel ?? p.severity ?? "";
    const impactLevel = p.impactLevel ?? p.impact ?? "";
    const environment = p.environment ?? p.environmentName ?? "";

    const affectedCI =
      p.affectedCI ??
      p.affectedEntities ??
      p.affectedEntitiesList ??
      [];

    const status = p.status ?? p.state ?? "";          // "OPEN" | "CLOSED"
    const tenant = p.tenant ?? p.domain ?? "";

    return {
      ...p,
      problemId,
      title,
      severityLevel,
      impactLevel,
      environment,
      affectedCI,
      status,
      tenant,
      label: isTcs ? "TCS" : "NO TCS",
      isTcs,
      startTime: startRaw ? new Date(startRaw).toISOString() : null,
      endTime: endRaw ? new Date(endRaw).toISOString() : null,
    };
  });
}

// 3) Fetch de UNA página con query-params
async function fetchPage({ pageNumber, pageSize, startIso, endIso }) {
  const params = new URLSearchParams();
  params.set("pageNumber", String(pageNumber));
  params.set("pageSize", String(pageSize));
  if (startIso) params.set("start", startIso);
  if (endIso) params.set("end", endIso);

  const url = `${API}?${params.toString()}`;
  const res = await fetch(url, { headers: { accept: "application/json" } });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status} en ${url}\n${txt}`);
  }

  // Puede venir array directo o envuelto
  const json = await res.json();
  const items = Array.isArray(json)
    ? json
    : json?.results || json?.items || json?.data || json?.value || [];

  return normalize(items);
}

// 4) Utilidad: rango para un solo día local
function getDayRange(dateStr /* YYYY-MM-DD */) {
  const start = new Date(`${dateStr}T00:00:00`);
  const end = new Date(`${dateStr}T23:59:59`);
  return { startIso: start.toISOString(), endIso: end.toISOString() };
}

// 4.b) Utilidad: convierte YYYY-MM-DD a límites de día en ISO
export function toLocalDayIsoRange(dateStr) {
  return getDayRange(dateStr);
}

// 5) Fetch histórico con paginado + filtros opcionales
export async function fetchAllProblems({
  onlyDate = ONLY_DATE,                 // si viene string => fuerza ese día; si null => sin límite
  pageSize = 500,
  maxPages = 40,
  onBatch,                              // (items) => void
  tcsFilter,                            // true | false | undefined
  statusFilter,                         // "OPEN" | "CLOSED" | undefined
  environmentFilter,                    // "Productivo" | "NoProductivo" | undefined (o parte del texto)
  startIso,                             // forzar ISO inicio
  endIso,                               // forzar ISO fin
  recentDays,                           // si quieres SOLO lo reciente (ej: 7)
} = {}) {
  // 1) Definir rango
  let range = { startIso, endIso };

  if (typeof recentDays === "number" && recentDays > 0) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - recentDays);
    range = { startIso: start.toISOString(), endIso: end.toISOString() };
  }

  if (!range.startIso && !range.endIso && typeof onlyDate === "string") {
    range = getDayRange(onlyDate);
  }

  // Si range sigue vacío => NO ponemos start/end => el API devuelve TODO
  let all = [];

  for (let page = 1; page <= maxPages; page++) {
    const batch = await fetchPage({
      pageNumber: page,
      pageSize,
      startIso: range.startIso,
      endIso: range.endIso,
    });

    if (!batch.length) break;

    // 2) Filtros opcionales en cliente
    let filtered = batch;

    if (typeof tcsFilter === "boolean") {
      filtered = filtered.filter((x) => x.isTcs === tcsFilter);
    }

    if (statusFilter) {
      const want = String(statusFilter).toUpperCase();
      filtered = filtered.filter((x) => (x.status || "").toUpperCase() === want);
    }

    if (environmentFilter) {
      const want = String(environmentFilter).toUpperCase();
      filtered = filtered.filter((x) => (x.environment || "").toUpperCase().includes(want));
    }

    if (onBatch) onBatch(filtered);
    all = all.concat(filtered);

    if (batch.length < pageSize) break; // última página
  }

  // Ordenar: más recientes primero (por startTime)
  all.sort((a, b) => {
    const da = a.startTime ? new Date(a.startTime).getTime() : 0;
    const db = b.startTime ? new Date(b.startTime).getTime() : 0;
    return db - da;
  });

  return all;
}

// 6) Fetch por rango de fechas (YYYY-MM-DD)
export async function fetchByDateRange({
  fromDate,         // "YYYY-MM-DD"
  toDate,           // "YYYY-MM-DD"
  tcsFilter,        // true | false | undefined
  statusFilter,     // "OPEN" | "CLOSED" | undefined
  environmentFilter // "Productivo" | "NoProductivo" | undefined
} = {}) {
  let startIso, endIso;

  if (fromDate && toDate) {
    const a = toLocalDayIsoRange(fromDate);
    const b = toLocalDayIsoRange(toDate);
    startIso = a.startIso;
    endIso = b.endIso;
  } else if (fromDate) {
    startIso = toLocalDayIsoRange(fromDate).startIso;
  } else if (toDate) {
    endIso = toLocalDayIsoRange(toDate).endIso;
  }

  return fetchAllProblems({
    onlyDate: null,
    startIso,
    endIso,
    tcsFilter,
    statusFilter,
    environmentFilter,
  });
}

// 7) Conveniencias
export const fetchTcsProblemsDay = (dateStr = ONLY_DATE, opts = {}) =>
  fetchAllProblems({ onlyDate: dateStr, tcsFilter: true, ...opts });

export const fetchNoTcsProblemsDay = (dateStr = ONLY_DATE, opts = {}) =>
  fetchAllProblems({ onlyDate: dateStr, tcsFilter: false, ...opts });

export const fetchTcsAllHistory = (opts = {}) =>
  fetchAllProblems({ onlyDate: null, tcsFilter: true, ...opts });

export const fetchNoTcsAllHistory = (opts = {}) =>
  fetchAllProblems({ onlyDate: null, tcsFilter: false, ...opts });

export const fetchRecentProblems = (recentDays = 7, opts = {}) =>
  fetchAllProblems({ onlyDate: null, recentDays, ...opts });

------

// ===============================
// src/components/DateRangeBar.jsx
// ===============================
import React, { useState } from "react";

export default function DateRangeBar({ onSearch, defaultFrom = "", defaultTo = "" }) {
  const [from, setFrom] = useState(defaultFrom);
  const [to, setTo] = useState(defaultTo);

  const fmt = (d) => {
    const m = `${d.getMonth() + 1}`.padStart(2, "0");
    const day = `${d.getDate()}`.padStart(2, "0");
    return `${d.getFullYear()}-${m}-${day}`;
  };

  const todayStr = () => fmt(new Date());

  const lastNDays = (n) => {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - (n - 1));
    setFrom(fmt(start));
    setTo(fmt(end));
  };

  const run = () => onSearch?.({ from, to });

  return (
    <div style={{ display: "flex", gap: ".5rem", alignItems: "center", marginBottom: "1rem" }}>
      <label>Desde:</label>
      <input type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
      <label>Hasta:</label>
      <input type="date" value={to} onChange={(e) => setTo(e.target.value)} />
      <button onClick={run}>Buscar</button>

      <div style={{ marginLeft: "1rem", display: "flex", gap: ".5rem" }}>
        <button type="button" onClick={() => { const t = todayStr(); setFrom(t); setTo(t); }}>
          Hoy
        </button>
        <button type="button" onClick={() => lastNDays(7)}>Últimos 7</button>
        <button type="button" onClick={() => lastNDays(30)}>Últimos 30</button>
      </div>
    </div>
  );
}

----

// ===============================
// src/pages/TCSProblems.jsx
// ===============================
import React, { useEffect, useState, useMemo } from "react";
import DateRangeBar from "../components/DateRangeBar";
import { fetchByDateRange } from "../api/problems";
import ProblemCard from "../components/ProblemCard";

const DEFAULT_STATUS = "OPEN"; // Solo abiertas por defecto

export default function TCSProblems() {
  const [items, setItems] = useState([]);
  const [range, setRange] = useState({ from: "", to: "" });
  const [envChip, setEnvChip] = useState("ALL"); // "ALL" | "Productivo" | "NoProductivo"
  const [statusChip, setStatusChip] = useState(DEFAULT_STATUS); // "OPEN" | "CLOSED"

  // primera carga: últimos 7 días TCS + OPEN
  useEffect(() => {
    const boot = async () => {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 6);
      const fmt = (d) =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(
          d.getDate()
        ).padStart(2, "0")}`;
      const from = fmt(start);
      const to = fmt(end);
      setRange({ from, to });

      const data = await fetchByDateRange({
        fromDate: from,
        toDate: to,
        tcsFilter: true,
        statusFilter: DEFAULT_STATUS,
      });
      setItems(data);
    };
    boot();
  }, []);

  const handleSearch = async ({ from, to }) => {
    setRange({ from, to });
    const data = await fetchByDateRange({
      fromDate: from || undefined,
      toDate: to || undefined,
      tcsFilter: true,
      statusFilter: statusChip, // respeta chip
      environmentFilter: envChip === "ALL" ? undefined : envChip,
    });
    setItems(data);
  };

  // Cambios de chips => re-consultar con el rango actual
  useEffect(() => {
    if (!range.from && !range.to) return;
    handleSearch(range);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [envChip, statusChip]);

  const counters = useMemo(() => {
    const prod = items.filter((x) => (x.environment || "").toUpperCase().includes("PRODUCTIVO")).length;
    const nprod = items.length - prod;
    const opens = items.filter((x) => (x.status || "").toUpperCase() === "OPEN").length;
    const closed = items.length - opens;
    return { prod, nprod, opens, closed };
  }, [items]);

  return (
    <div>
      <h2>Problemas TCS ({items.length})</h2>

      <DateRangeBar onSearch={handleSearch} defaultFrom={range.from} defaultTo={range.to} />

      {/* Chips simples */}
      <div style={{ display: "flex", gap: ".5rem", marginBottom: "1rem" }}>
        <button
          onClick={() => setEnvChip("Productivo")}
          style={{ background: envChip === "Productivo" ? "#d1e7dd" : "" }}
        >
          Productivo ({counters.prod})
        </button>
        <button
          onClick={() => setEnvChip("NoProductivo")}
          style={{ background: envChip === "NoProductivo" ? "#fff3cd" : "" }}
        >
          No Productivo ({counters.nprod})
        </button>
        <button onClick={() => setEnvChip("ALL")} style={{ background: envChip === "ALL" ? "#e2e3e5" : "" }}>
          Todos
        </button>

        <span style={{ width: "2rem" }} />

        <button
          onClick={() => setStatusChip("OPEN")}
          style={{ background: statusChip === "OPEN" ? "#f8d7da" : "" }}
        >
          Abiertas ({counters.opens})
        </button>
        <button
          onClick={() => setStatusChip("CLOSED")}
          style={{ background: statusChip === "CLOSED" ? "#d1e7dd" : "" }}
        >
          Cerradas ({counters.closed})
        </button>
      </div>

      {items.map((p) => (
        <ProblemCard key={p.problemId || `${p.title}-${p.startTime}`} problem={p} username={""} />
      ))}
    </div>
  );
}

-----

// ===============================
// src/pages/OtherProblems.jsx
// ===============================
import React, { useEffect, useMemo, useState } from "react";
import DateRangeBar from "../components/DateRangeBar";
import { fetchByDateRange } from "../api/problems";
import ProblemCard from "../components/ProblemCard";

const DEFAULT_STATUS = "OPEN";

export default function OtherProblems() {
  const [items, setItems] = useState([]);
  const [range, setRange] = useState({ from: "", to: "" });
  const [envChip, setEnvChip] = useState("ALL");
  const [statusChip, setStatusChip] = useState(DEFAULT_STATUS);

  useEffect(() => {
    const boot = async () => {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 6);
      const fmt = (d) =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(
          d.getDate()
        ).padStart(2, "0")}`;
      const from = fmt(start);
      const to = fmt(end);
      setRange({ from, to });

      const data = await fetchByDateRange({
        fromDate: from,
        toDate: to,
        tcsFilter: false,
        statusFilter: DEFAULT_STATUS,
      });
      setItems(data);
    };
    boot();
  }, []);

  const handleSearch = async ({ from, to }) => {
    setRange({ from, to });
    const data = await fetchByDateRange({
      fromDate: from || undefined,
      toDate: to || undefined,
      tcsFilter: false,
      statusFilter: statusChip,
      environmentFilter: envChip === "ALL" ? undefined : envChip,
    });
    setItems(data);
  };

  useEffect(() => {
    if (!range.from && !range.to) return;
    handleSearch(range);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [envChip, statusChip]);

  const counters = useMemo(() => {
    const prod = items.filter((x) => (x.environment || "").toUpperCase().includes("PRODUCTIVO")).length;
    const nprod = items.length - prod;
    const opens = items.filter((x) => (x.status || "").toUpperCase() === "OPEN").length;
    const closed = items.length - opens;
    return { prod, nprod, opens, closed };
  }, [items]);

  return (
    <div>
      <h2>Problemas Otros ({items.length})</h2>

      <DateRangeBar onSearch={handleSearch} defaultFrom={range.from} defaultTo={range.to} />

      <div style={{ display: "flex", gap: ".5rem", marginBottom: "1rem" }}>
        <button
          onClick={() => setEnvChip("Productivo")}
          style={{ background: envChip === "Productivo" ? "#d1e7dd" : "" }}
        >
          Productivo ({counters.prod})
        </button>
        <button
          onClick={() => setEnvChip("NoProductivo")}
          style={{ background: envChip === "NoProductivo" ? "#fff3cd" : "" }}
        >
          No Productivo ({counters.nprod})
        </button>
        <button onClick={() => setEnvChip("ALL")} style={{ background: envChip === "ALL" ? "#e2e3e5" : "" }}>
          Todos
        </button>

        <span style={{ width: "2rem" }} />

        <button
          onClick={() => setStatusChip("OPEN")}
          style={{ background: statusChip === "OPEN" ? "#f8d7da" : "" }}
        >
          Abiertas ({counters.opens})
        </button>
        <button
          onClick={() => setStatusChip("CLOSED")}
          style={{ background: statusChip === "CLOSED" ? "#d1e7dd" : "" }}
        >
          Cerradas ({counters.closed})
        </button>
      </div>

      {items.map((p) => (
        <ProblemCard key={p.problemId || `${p.title}-${p.startTime}`} problem={p} username={""} />
      ))}
    </div>
  );
}
