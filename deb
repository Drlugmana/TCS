// src/pages/OtherProblems.jsx
import React, { useEffect, useState } from "react";
import { fetchNoTcsProblemsDay, ONLY_DATE } from "../api/problems";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";

/* -----------------------------------------------
   ðŸ” FunciÃ³n que determina el ambiente
   Usa mÃºltiples claves posibles: environment, icons, text, etc.
----------------------------------------------- */
function detectEnvironment(problem) {
  if (!problem) return "";
  // Tomar texto del ambiente o Ã­cono si existe
  const raw =
    problem.environment ||
    problem.environmentText ||
    problem.environmentIcon ||
    problem.entorno ||
    problem.env ||
    "";
  return String(raw).toLowerCase().trim();
}

/* -----------------------------------------------
   ðŸ§© Clasificador robusto
   Detecta si un problema es Productivo o No Productivo
   - Usa palabras clave
   - Detecta Ã­conos tipo "PROD" o "EnP"
----------------------------------------------- */
function isProd(problem) {
  const env = detectEnvironment(problem);

  // Primero detectamos ambientes no productivos
  const nonProd = [
    "enp",
    "no prod",
    "non-prod",
    "non prod",
    "np",
    "qa",
    "q/a",
    "dev",
    "desa",
    "desarrollo",
    "test",
    "stg",
    "stage",
    "staging",
    "uat",
    "preprod",
    "pre-prod",
    "pre prod",
  ];
  if (nonProd.some((k) => env.includes(k))) return false;

  // Luego ambientes productivos
  const prod = ["prod", "productivo", "produccion", "producciÃ³n", "production"];
  if (prod.some((k) => env.includes(k))) return true;

  // Si no reconoce nada, tratamos como No Productivo
  return false;
}

/* -----------------------------------------------
   ðŸŒ Componente principal
----------------------------------------------- */
export default function OtherProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");
  const [tab, setTab] = useState("prod");

  useEffect(() => {
    let mounted = true;

    async function load() {
      try {
        setLoading(true);
        setError(null);
        setProblems([]);

        await fetchNoTcsProblemsDay(ONLY_DATE, {
          onBatch: (batch) => {
            if (!mounted || !batch?.length) return;
            setProblems((prev) =>
              [...prev, ...batch].sort(
                (a, b) => new Date(b.startTime) - new Date(a.startTime)
              )
            );
          },
        });
      } catch (e) {
        setError(e.message || String(e));
      } finally {
        if (mounted) setLoading(false);
      }
    }

    load();
    return () => {
      mounted = false;
    };
  }, []);

  if (error) return <h2 style={{ color: "red" }}>Error: {error}</h2>;

  /* ðŸ”¹ Clasificar por ambiente */
  const prodList = problems.filter((p) => isProd(p));
  const nonProdList = problems.filter((p) => !isProd(p));
  const selectedList = tab === "prod" ? prodList : nonProdList;

  /* ðŸ”¹ Render */
  return (
    <div style={{ maxWidth: "900px", margin: "0 auto", padding: "1rem" }}>
      <h2>
        Problemas Otros <span>({problems.length})</span>
      </h2>

      <UsernameInput value={username} onChange={setUsername} />

      {loading && problems.length === 0 && <p>Cargando problemasâ€¦</p>}
      {!loading && problems.length === 0 && <p>No hay problemas el {ONLY_DATE}.</p>}

      {/* Tabs de filtrado */}
      <div style={{ display: "flex", gap: ".5rem", margin: "1rem 0" }}>
        <button
          onClick={() => setTab("prod")}
          disabled={tab === "prod"}
          style={{
            padding: ".4rem .8rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: tab === "prod" ? "#dbeafe" : "#f8fafc",
            fontWeight: tab === "prod" ? "bold" : "normal",
            cursor: tab === "prod" ? "default" : "pointer",
          }}
        >
          Productivo ({prodList.length})
        </button>

        <button
          onClick={() => setTab("nonprod")}
          disabled={tab === "nonprod"}
          style={{
            padding: ".4rem .8rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: tab === "nonprod" ? "#fef3c7" : "#f8fafc",
            fontWeight: tab === "nonprod" ? "bold" : "normal",
            cursor: tab === "nonprod" ? "default" : "pointer",
          }}
        >
          No Productivo ({nonProdList.length})
        </button>
      </div>

      {/* Lista de problemas segÃºn la pestaÃ±a activa */}
      {selectedList.map((p) => (
        <ProblemCard key={p.problemId || p.pid} problem={p} username={username} />
      ))}
    </div>
  );
}