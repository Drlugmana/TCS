

<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 100 100">
  <polygon fill="#2D2D2D" stroke="#000" stroke-width="2" points="50,2 98,25 98,75 50,98 2,75 2,25"/>
  <text x="50%" y="56%" text-anchor="middle" fill="white" font-size="28" font-family="Arial" font-weight="bold">UNIX</text>
</svg>

// src/components/ProblemCard.jsx
import React, { useEffect, useState } from "react";
import {
  getSlaMinutes,
  getColorByPercent,
  getButtonColorByPercent,
  calcularCriticidadDetallada,
} from "../utils/slaUtils";
import { useBiaCatalog } from "../context/BiaCatalogContext";

// === Normaliza estado OPEN/CLOSED (con fallback por endTime) ===
function normalizeStatus(p) {
  const raw =
    p?.status ??
    p?.Status ??
    p?.problemStatus ??
    "";

  const s = String(raw).trim().toUpperCase();
  if (!s) {
    // Si no vino status pero SÍ hay endTime => se cerró
    if (p?.endTime) return "CLOSED";
    return "OPEN";
  }
  if (s.includes("CLOSED") || s.includes("RESOLVED")) return "CLOSED";
  if (s.includes("OPEN")) return "OPEN";
  return "OPEN";
}

// === Mapea towerKey a ícono (los tuyos en /public/icons/towers/) ===
function towerToIconPath(towerKey) {
  if (!towerKey) return null;
  const key = String(towerKey).toLowerCase();

  if (key.includes("wintel") || key.includes("windows")) {
    return "/icons/towers/wintel.svg";
  }
  if (
    key.includes("bdd") ||
    key.includes("base de datos") ||
    key.includes("database") ||
    key.includes("bd")
  ) {
    return "/icons/towers/Base.svg";
  }
  if (key.includes("unix") || key.includes("aix") || key.includes("linux")) {
    return "/icons/towers/unix.svg";
  }
  return null;
}

export default function ProblemCard({ problem, username }) {
  const {
    title,
    severityLevel,
    impactLevel,
    startTime,
    endTime,
    environment,
    affectedCI = [],
    tenant,
    problemId,
  } = problem;

  const { get: catalogGet } = useBiaCatalog();

  // Busca coincidencia en tu catálogo para tower e info extra
  const hitFromCatalog = (() => {
    for (const ci of affectedCI ?? []) {
      const name = ci?.name ?? ci?.Nombre;
      const hit = name ? catalogGet(name) : null;
      if (hit) return hit;
    }
    return null;
  })();

  const towerIcon = towerToIconPath(hitFromCatalog?.tower);
  const criticidad = calcularCriticidadDetallada(problem, {
    catalogLookup: (ciName) => catalogGet(ciName),
  });

  // === Estado OPEN/CLOSED ===
  const status = normalizeStatus(problem);
  const statusStyle =
    status === "CLOSED"
      ? { background: "#16a34a", color: "#fff" } // verde
      : { background: "#dc2626", color: "#fff" }; // rojo

  const statusBadgeBase = {
    padding: "0.15rem .55rem",
    borderRadius: "999px",
    fontSize: ".8rem",
    fontWeight: 700,
    lineHeight: 1.4,
    display: "inline-block",
  };

  // === SLA / colores ===
  const slaMinutes = getSlaMinutes(criticidad);
  const start = new Date(startTime);

  // ⏱️ El reloj solo corre si está OPEN
  const [now, setNow] = useState(() => {
    // Si está CLOSED congelamos “ahora” en endTime (o en start si faltara)
    return status === "CLOSED"
      ? new Date(endTime ?? startTime)
      : new Date();
  });

  useEffect(() => {
    if (status !== "OPEN") return; // NO interval si está cerrado
    const interval = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(interval);
  }, [status]);

  // Para colores de la tarjeta: usamos porcentaje restante (solo sentido si OPEN)
  const elapsedMinutes = Math.max((now - start) / 60000, 0);
  const remainingMinutes = Math.max(slaMinutes - elapsedMinutes, 0);
  const percentRemaining =
    slaMinutes > 0 ? Math.max((remainingMinutes / slaMinutes) * 100, 0) : 0;

  const bgColor = getColorByPercent(percentRemaining);
  const buttonColor = getButtonColorByPercent(percentRemaining);

  const formatTime = (minutes) => {
    const totalSeconds = Math.floor(minutes * 60);
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    return `${String(hrs).padStart(2, "0")}:${String(mins).padStart(
      2,
      "0"
    )}:${String(secs).padStart(2, "0")}`;
  };

  // Texto fijo si está CLOSED
  const timeText =
    status === "CLOSED" ? "00:00:00" : formatTime(remainingMinutes);

  const uniqueNames = [...new Set((affectedCI ?? []).map((ci) => ci?.name).filter(Boolean))];
  const equipos = uniqueNames.join(", ");
  const isDisabled = !!username;
  const dynatraceUrl = `https://${tenant}.live.dynatrace.com/#problems/problemdetails;pid=${problemId}`;

  return (
    <div
      style={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        borderRadius: "12px",
        padding: "1rem 1.5rem",
        marginBottom: "1rem",
        backgroundColor: bgColor,
        boxShadow: "0 4px 10px rgba(0,0,0,.1)",
        opacity: status === "CLOSED" ? 0.9 : 1, // atenuar cuando está cerrado
      }}
    >
      {/* INFO IZQUIERDA */}
      <div style={{ flex: 1, paddingRight: "1rem" }}>
        <h3 style={{ margin: 0, fontSize: "1.6rem", fontWeight: "bold" }}>
          {title}
        </h3>

        <p style={{ fontSize: "1.2rem" }}>
          <strong>Severidad Dynatrace:</strong> {severityLevel}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Impacto:</strong> {impactLevel}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Inicio:</strong> {start.toLocaleString()}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Estado:</strong>{" "}
          <span style={{ ...statusBadgeBase, ...statusStyle }}>{status}</span>
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Criticidad (BIA):</strong> {criticidad}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Equipos afectados:</strong> <small>{equipos}</small>
        </p>
      </div>

      {/* ICONOS + RELOJ DERECHA */}
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: "0.8rem",
          minWidth: "260px",
          justifyContent: "flex-end",
        }}
      >
        {/* Severidad (S1..S4) */}
        <img
          src={`/severidad${criticidad}.svg`}
          width="60"
          height="60"
          title={`Criticidad ${criticidad}`}
          alt="severity"
        />

        {/* Entorno (PROD / No PROD) */}
        <img
          src={environment === "Productivo" ? "/icon-productivo.svg" : "/icon-noproductivo.svg"}
          width="60"
          height="60"
          title={environment}
          alt="environment"
        />

        {/* Torre (Unix/Wintel/BD …) */}
        {towerIcon && (
          <img
            src={towerIcon}
            width="60"
            height="60"
            alt="tower"
            title={hitFromCatalog?.towerRaw || hitFromCatalog?.tower}
            style={{ objectFit: "contain" }}
          />
        )}

        {/* Tiempo / Botón */}
        <div style={{ textAlign: "right", minWidth: "140px" }}>
          <div style={{ fontSize: "2rem", fontWeight: "bold" }}>{timeText}</div>
          <button
            disabled={isDisabled || status === "CLOSED"}
            onClick={() => window.open(dynatraceUrl, "_blank")}
            style={{
              marginTop: ".5rem",
              padding: ".3rem 1rem",
              fontSize: ".9rem",
              fontWeight: "bold",
              color: "#fff",
              backgroundColor:
                status === "CLOSED" ? "#b0b0b0" : buttonColor,
              border: "none",
              borderRadius: "8px",
              cursor:
                isDisabled || status === "CLOSED" ? "not-allowed" : "pointer",
            }}
          >
            Revisar problema
          </button>
        </div>
      </div>
    </div>
  );
}
