// src/components/ProblemCard.jsx
import React, { useEffect, useState } from "react";
import {
  getSlaMinutes,
  getColorByPercent,
  getButtonColorByPercent,
  calcularCriticidadDetallada,
} from "../utils/slaUtils";
import { useBiaCatalog } from "../context/BiaCatalogContext";

// ==== Normaliza estado OPEN/CLOSED (con fallback por endTime) ====
function normalizeStatus(p) {
  const raw =
    p?.status ??
    p?.Status ??
    p?.problemStatus ??
    "";

  const s = String(raw).trim().toUpperCase();

  // Si no vino status pero sÃ­ hay endTime => se cerrÃ³
  if (!s) {
    if (p?.endTime) return "CLOSED";
    return "OPEN";
  }
  if (s.includes("CLOSED") || s.includes("RESOLVED")) return "CLOSED";
  if (s.includes("OPEN")) return "OPEN";
  return p?.endTime ? "CLOSED" : "OPEN";
}

// ==== Traduce towerKey -> Ã­cono (ajusta rutas a tus SVG/PNG) ====
function towerToIconPath(towerKey) {
  if (!towerKey) return null;
  const key = String(towerKey).toLowerCase();

  if (key.includes("wintel") || key.includes("windows")) {
    return "/icons/towers/wintel.svg";
  }
  if (
    key.includes("bdd") ||
    key.includes("base de datos") ||
    key.includes("database") ||
    key.includes("bd")
  ) {
    return "/icons/towers/base.svg";
  }
  if (key.includes("unix") || key.includes("aix") || key.includes("linux")) {
    return "/icons/towers/unix.svg";
  }
  return null;
}

export default function ProblemCard({ problem, username }) {
  const {
    title,
    severityLevel = "",
    impactLevel = "",
    startTime,
    endTime,
    environment = "",
    affectedCI = [],
    tenant,
    problemId,
  } = problem;

  const { get: catalogGet } = useBiaCatalog();

  // Buscar coincidencia con catÃ¡logo
  const hitFromCatalog = (() => {
    for (const ci of affectedCI || []) {
      const name = ci?.name || ci?.Nombre;
      const hit = name ? catalogGet(name) : null;
      if (hit) return hit;
    }
    return null;
  })();

  const towerIcon = towerToIconPath(hitFromCatalog?.tower);
  const criticidad = calcularCriticidadDetallada(problem, {
    catalogLookup: (ciName) => catalogGet(ciName),
  });

  // === ESTADO OPEN/CLOSED ===
  const status = normalizeStatus(problem);
  const statusStyle =
    status === "CLOSED"
      ? { background: "#16a34a", color: "#fff" } // Verde
      : { background: "#dc2626", color: "#fff" }; // Rojo

  const statusBadgeBase = {
    padding: "0.15rem .55rem",
    borderRadius: "999px",
    fontSize: ".8rem",
    fontWeight: 700,
    lineHeight: 1.4,
    display: "inline-block",
  };

  // === SLA / colores ===
  const slaMinutes = getSlaMinutes(criticidad);
  const start = new Date(startTime);
  const end = endTime ? new Date(endTime) : null;

  // Estado para el reloj (solo si estÃ¡ OPEN)
  const [now, setNow] = useState(new Date());
  useEffect(() => {
    if (status !== "OPEN") return; // ðŸ”’ no crear intervalo si estÃ¡ cerrado
    const id = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(id);
  }, [status]);

  // Si estÃ¡ OPEN, el tiempo progresa con 'now'.
  // Si estÃ¡ CLOSED, se â€œcongelaâ€ usando 'end' (o 0 si no hay end aÃºn).
  const elapsedMinutes =
    status === "OPEN"
      ? Math.max((now - start) / 60000, 0)
      : Math.max(((end ?? start) - start) / 60000, 0);

  const remainingMinutes = Math.max(slaMinutes - elapsedMinutes, 0);
  const percentRemaining = Math.max((remainingMinutes / slaMinutes) * 100, 0);

  const bgColor = getColorByPercent(percentRemaining);
  const buttonColor =
    status === "OPEN"
      ? getButtonColorByPercent(percentRemaining)
      : "#b0b0b0";

  // Formateo hh:mm:ss
  const formatTime = (minutes) => {
    const totalSeconds = Math.floor(minutes * 60);
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    return `${String(hrs).padStart(2, "0")}:${String(mins).padStart(
      2,
      "0"
    )}:${String(secs).padStart(2, "0")}`;
  };

  // â± En OPEN mostramos cuenta regresiva; en CLOSED mostramos la duraciÃ³n total del incidente.
  const timeText =
    status === "OPEN"
      ? formatTime(remainingMinutes)
      : formatTime(elapsedMinutes);

  const uniqueNames = [...new Set((affectedCI || []).map((ci) => ci?.name).filter(Boolean))];
  const equipos = uniqueNames.join(", ");
  const isDisabled = status !== "OPEN";
  const dynatraceUrl = `https://${tenant}.live.dynatrace.com/#problems/problemdetails;pid=${problemId}`;

  return (
    <div
      style={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        borderRadius: "12px",
        padding: "1rem 1.5rem",
        marginBottom: "1rem",
        backgroundColor: bgColor,
        boxShadow: "0 4px 10px rgba(0,0,0,.1)",
        opacity: status === "CLOSED" ? 0.9 : 1, // opcional: atenuar cerrados
      }}
    >
      {/* ===== INFO IZQUIERDA ===== */}
      <div style={{ flex: 1, paddingRight: "1rem" }}>
        <h3 style={{ margin: 0, fontSize: "1.6rem", fontWeight: "bold" }}>
          {title}
        </h3>

        <p style={{ fontSize: "1.2rem" }}>
          <strong>Severidad Dynatrace:</strong> {severityLevel}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Impacto:</strong> {impactLevel}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Inicio:</strong> {start.toLocaleString()}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Estado:</strong>{" "}
          <span style={{ ...statusBadgeBase, ...statusStyle }}>{status}</span>
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Criticidad (BIA):</strong> {criticidad}
        </p>
        <p style={{ fontSize: "1.2rem" }}>
          <strong>Equipos afectados:</strong> <small>{equipos}</small>
        </p>
      </div>

      {/* ===== ICONOS CENTRO/DERECHA ===== */}
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: "0.8rem",
          minWidth: "160px",
          justifyContent: "center",
          marginRight: "1rem",
        }}
      >
        {/* Severidad */}
        <img
          src={`/severidad${criticidad}.svg`}
          width={60}
          height={60}
          title={`Criticidad ${criticidad}`}
          alt={`Criticidad ${criticidad}`}
        />
        {/* Entorno */}
        <img
          src={environment === "Productivo" ? "/icon-productivo.svg" : "/icon-noproductivo.svg"}
          width={60}
          height={60}
          title={environment}
          alt={environment}
        />
        {/* Torre (Wintel/Unix/DB) */}
        {towerIcon && (
          <img
            src={towerIcon}
            width={60}
            height={60}
            alt="tower"
            title={hitFromCatalog?.towerRaw || hitFromCatalog?.tower}
          />
        )}
      </div>

      {/* ===== CRONÃ“METRO + BOTÃ“N ===== */}
      <div style={{ textAlign: "center" }}>
        <div style={{ fontSize: "1.8rem", fontWeight: "bold" }}>{timeText}</div>
        <button
          disabled={isDisabled}
          onClick={() => window.open(dynatraceUrl, "_blank")}
          style={{
            marginTop: ".5rem",
            padding: ".3rem 1rem",
            fontSize: ".9rem",
            fontWeight: "bold",
            color: "#fff",
            backgroundColor: buttonColor,
            border: "none",
            borderRadius: "8px",
            cursor: isDisabled ? "not-allowed" : "pointer",
          }}
        >
          Revisar problema
        </button>
      </div>
    </div>
  );
}