using System;
using System.IO;
using Microsoft.ML;
using DynatraceProblemUpdater.Models.ML;

namespace DynatraceProblemUpdater.Data.Sources.ML
{
    /// <summary>
    /// Cargador del modelo ML.NET y métodos de predicción.
    /// </summary>
    public class MLPredictor
    {
        // Ruta: coloca el ZIP del modelo en /MLModels/jurisdiction_model.zip
        private static readonly string _modelPath =
            Path.Combine(AppContext.BaseDirectory, "MLModels", "jurisdiction_model.zip");

        private static readonly MLContext _mlContext = new MLContext();

        private readonly PredictionEngine<DynatraceIssue, IssuePrediction> _predictionEngine;

        /// <summary>
        /// Carga el modelo entrenado una vez.
        /// </summary>
        public MLPredictor()
        {
            try
            {
                using var fs = File.OpenRead(_modelPath);
                var loadedModel = _mlContext.Model.Load(fs, out _);
                _predictionEngine = _mlContext.Model.CreatePredictionEngine<DynatraceIssue, IssuePrediction>(loadedModel);
            }
            catch (Exception ex)
            {
                // Si ves "Could not find input column 'ProblemTitle' (Parameter 'inputSchema')"
                // es porque la clase de entrada no coincide con el esquema del modelo.
                // Aquí ya nos aseguramos de usar "ProblemTitleTextSpan".
                throw new Exception($"⚠️ Error al cargar el modelo de ML.NET: {ex.Message}");
            }
        }

        // =======================
        // Predicción por TÍTULO
        // =======================
        public bool TryPredictByTitle(string title, out bool isTcs, out float probability, double threshold = 0.5)
        {
            isTcs = false;
            probability = float.NaN;

            if (string.IsNullOrWhiteSpace(title))
                return false;

            var input = BuildInputFromTitle(title);
            var pred = _predictionEngine.Predict(input);

            probability = pred.Probability;
            isTcs = (double)pred.Probability >= threshold ? true : pred.EventoTCS;
            return true;
        }

        // =====================================
        // Predicción COMPLETA usando más campos
        // =====================================
        public IssuePrediction Predict(
            string shortDescription,
            string impactLevel = null,
            string severityLevel = null,
            string affectedCIGroups = null,
            string entityTags = null,
            string affectedCINames = null,
            string affectedCIServerClasses = null,
            string problemFilters = null,
            string managementZones = null,
            float underMaintenance = 0f,
            string rootCauseEntity = null)
        {
            var input = new DynatraceIssue
            {
                ShortDescription        = shortDescription ?? string.Empty,
                ImpactLevel             = impactLevel ?? string.Empty,
                SeverityLevel           = severityLevel ?? string.Empty,
                AffectedCI_Groups       = affectedCIGroups ?? string.Empty,
                EntityTags              = entityTags ?? string.Empty,
                AffectedCI_Names        = affectedCINames ?? string.Empty,
                AffectedCI_ServerClasses= affectedCIServerClasses ?? string.Empty,
                ProblemFilters          = problemFilters ?? string.Empty,
                ManagementZones         = managementZones ?? string.Empty,
                UnderMaintenance        = underMaintenance,
                RootCauseEntity         = rootCauseEntity ?? string.Empty
            };

            // IMPORTANTÍSIMO: rellenamos también la columna real usada por el modelo
            TrySetProblemTitle(input, shortDescription);

            return _predictionEngine.Predict(input);
        }

        // =======================
        // HELPERS PRIVADOS
        // =======================

        /// <summary>Construye un input cuando solo tienes el Title.</summary>
        private static DynatraceIssue BuildInputFromTitle(string title)
        {
            var input = new DynatraceIssue
            {
                ShortDescription = title ?? string.Empty,
                ImpactLevel = string.Empty,
                SeverityLevel = string.Empty,
                AffectedCI_Groups = string.Empty,
                EntityTags = string.Empty,
                AffectedCI_Names = string.Empty,
                AffectedCI_ServerClasses = string.Empty,
                ProblemFilters = string.Empty,
                ManagementZones = string.Empty,
                UnderMaintenance = 0f,
                RootCauseEntity = string.Empty
            };

            TrySetProblemTitle(input, title);
            return input;
        }

        /// <summary>
        /// Setea la propiedad exacta que el modelo espera:
        /// - Primero intenta "ProblemTitleTextSpan" (tu modelo nuevo).
        /// - Como fallback, si hubiera otro nombre "ProblemTitle", también lo setea.
        /// </summary>
        private static void TrySetProblemTitle(DynatraceIssue input, string text)
        {
            var value = text ?? string.Empty;

            var propTextSpan = typeof(DynatraceIssue).GetProperty("ProblemTitle");
            if (propTextSpan != null && propTextSpan.CanWrite)
            {
                propTextSpan.SetValue(input, value);
            }

            // (Opcional) Si en alguna rama conservas una propiedad adicional "ProblemTitle" distinta:
            var propLegacy = typeof(DynatraceIssue).GetProperty("ProblemTitleTextSpan");
            if (propLegacy != null && propLegacy.CanWrite)
            {
                propLegacy.SetValue(input, value);
            }
        }
    }
}