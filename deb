import React, { useRef, useState } from 'react';
import { useBiaCatalog } from '../context/BiaCatalogContext';

export default function BiaCatalogLoader() {
  const { setFromFile, size, updatedAt, clear } = useBiaCatalog();
  const [busy, setBusy] = useState(false);
  const inputRef = useRef(null);

  const onPick = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    setBusy(true);
    try {
      const count = await setFromFile(f);
      alert(`Catálogo cargado: ${count} CIs.`);
    } catch (err) {
      console.error(err);
      alert('No pude leer el CSV. Asegúrate de columnas "Nombre" y "CI Business criticality".');
    } finally {
      setBusy(false);
      if (inputRef.current) inputRef.current.value = '';
    }
  };

  return (
    <div style={{ display: 'flex', gap: '.5rem', alignItems: 'center' }}>
      <input
        ref={inputRef}
        type="file"
        accept=".csv,text/csv"
        onChange={onPick}
        disabled={busy}
      />
      <button onClick={clear} disabled={busy || size===0}>Limpiar catálogo</button>
      <small style={{ opacity:.7 }}>
        {size} CIs cargados {updatedAt ? `· ${new Date(updatedAt).toLocaleString()}` : ''}
      </small>
    </div>
  );
}