// src/api/problems.js

//-----------------------------------------------------------
// 1) LEER LA URL BASE DEL BACKEND DESDE EL ARCHIVO .env
//-----------------------------------------------------------
const BASE = (import.meta.env.VITE_API_URL || "").replace(/\/$/, "");

if (!BASE) {
  throw new Error(
    "âŒ ERROR: Falta definir VITE_API_URL en .env (ejemplo: VITE_API_URL=https://tu-backend)"
  );
}

const API = `${BASE}/api/Problems`;


//-----------------------------------------------------------
// 2) NORMALIZAR ALERTAS DEL BACKEND
//-----------------------------------------------------------
function normalize(list) {
  if (!Array.isArray(list)) list = [];

  return list.map((p) => {
    const isTcsFromObject = p?.jurisdiction?.isTcs;
    const isTcsFromString =
      typeof p?.juris === "string"
        ? p.juris.toUpperCase() === "TCS"
        : undefined;

    const isTcs = isTcsFromObject ?? isTcsFromString ?? false;
    const label =
      p?.jurisdiction?.label ??
      p?.label ??
      (isTcs ? "TCS" : "NO TCS");

    return {
      ...p,
      isTcs,
      label,
      title: p.title || p.shortDescription || "(sin tÃ­tulo)",
      severityLevel: p.severityLevel || p.severity || "",
      impactLevel: p.impactLevel || p.impact || "",
      startTime: p.startTime || p.startTimeUtc || null,
      affectedCI: p.affectedEntities || p.affectedCI || [],
      environment: p.environment || p.environmentName || "",
      problemId: p.problemId || p.displayId || p.id || "",
      status: p.status || p.state || "",
    };
  });
}


//-----------------------------------------------------------
// 3) OBTENER UNA ÃšNICA PÃGINA
//-----------------------------------------------------------
async function fetchPage(page, size = 50) {
  const url = `${API}?pageNumber=${page}&pageSize=${size}`;

  const res = await fetch(url, {
    headers: { accept: "application/json" },
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(
      `âŒ HTTP ${res.status} al obtener problemas:\n${txt}`
    );
  }

  const json = await res.json();

  // Detectar si es array o si viene como {results:[], total:100}
  return Array.isArray(json)
    ? json
    : json?.results || json?.items || json?.data || json?.value || [];
}


//-----------------------------------------------------------
// 4) ðŸ”¥ TRAER TODO EL HISTÃ“RICO DE ALERTAS (MULTIPÃGINA)
//-----------------------------------------------------------
export async function fetchAllProblems(size = 50) {
  let page = 1;
  let all = [];

  while (true) {
    const batch = await fetchPage(page, size);

    if (!batch || batch.length === 0) break;

    all = [...all, ...batch];
    page++;
  }

  return normalize(all);
}


------

import React, { useEffect, useState } from "react";
import { fetchAllProblems } from "../api/problems";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";

export default function AllProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");

  useEffect(() => {
    async function load() {
      try {
        const data = await fetchAllProblems();
        data.sort(
          (a, b) => new Date(b.startTime) - new Date(a.startTime)
        );
        setProblems(data);
      } catch (err) {
        setError(err.message);
      }
      setLoading(false);
    }
    load();
  }, []);

  if (loading) return <h2>Cargando todos los problemas...</h2>;
  if (error) return <h2 style={{ color: "red" }}>{error}</h2>;
  if (problems.length === 0)
    return <h2>No hay problemas actualmente.</h2>;

  return (
    <>
      <h2>Todos los problemas</h2>
      <UsernameInput value={username} onChange={setUsername} />

      {problems.map((p) => (
        <ProblemCard key={p.problemId} problem={p} username={username} />
      ))}
    </>
  );
}

----

import React, { useEffect, useState } from "react";
import { fetchAllProblems } from "../api/problems";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";

export default function TCSProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");

  useEffect(() => {
    async function load() {
      try {
        const data = await fetchAllProblems();

        const onlyTcs = data.filter((p) => p.isTcs === true);

        onlyTcs.sort(
          (a, b) => new Date(b.startTime) - new Date(a.startTime)
        );

        setProblems(onlyTcs);
      } catch (e) {
        setError(e.message);
      }
      setLoading(false);
    }
    load();
  }, []);

  if (loading) return <h2>Cargando problemas TCS...</h2>;
  if (error) return <h2 style={{ color: "red" }}>{error}</h2>;
  if (problems.length === 0)
    return <h2>No hay problemas TCS actualmente.</h2>;

  return (
    <>
      <h2>Problemas TCS</h2>
      <UsernameInput value={username} onChange={setUsername} />

      {problems.map((p) => (
        <ProblemCard key={p.problemId} problem={p} username={username} />
      ))}
    </>
  );
}

-----

import React, { useEffect, useState } from "react";
import { fetchAllProblems } from "../api/problems";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";

export default function OtherProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");

  useEffect(() => {
    async function load() {
      try {
        const data = await fetchAllProblems();

        const others = data.filter((p) => p.isTcs === false);

        others.sort(
          (a, b) => new Date(b.startTime) - new Date(a.startTime)
        );

        setProblems(others);
      } catch (e) {
        setError(e.message);
      }
      setLoading(false);
    }
    load();
  }, []);

  if (loading) return <h2>Cargando problemas de terceros...</h2>;
  if (error) return <h2 style={{ color: "red" }}>{error}</h2>;
  if (problems.length === 0)
    return <h2>No hay problemas de terceros actualmente.</h2>;

  return (
    <>
      <h2>Problemas Otros</h2>
      <UsernameInput value={username} onChange={setUsername} />

      {problems.map((p) => (
        <ProblemCard key={p.problemId} problem={p} username={username} />
      ))}
    </>
  );
}