// ... arriba ...
var normalizedEntities = new ConcurrentDictionary<string, List<EntitySchema>>();

foreach (var kvp in entitiesList)
{
    var full = (kvp.Key ?? "").Trim().ToUpper();        // FQDN tal cual
    var shortName = full.Split('.')[0];                  // shortname

    normalizedEntities.AddOrUpdate(
        full,
        _ => new List<EntitySchema>(kvp.Value),
        (_, existing) => { existing.AddRange(kvp.Value); return existing; });

    if (!string.IsNullOrWhiteSpace(shortName))
    {
        normalizedEntities.AddOrUpdate(
            shortName,
            _ => new List<EntitySchema>(kvp.Value),
            (_, existing) => { existing.AddRange(kvp.Value); return existing; });
    }
}
// ... abajo ...


-----

// ... arriba ...
var original = (server.Name ?? "").Trim();
var fullKey  = original.ToUpperInvariant();
var shortKey = fullKey.Split('.')[0];

List<EntitySchema>? matchedEntities = null;

if (normalizedEntities.TryGetValue(fullKey, out var listFull))
    matchedEntities = listFull;
else if (normalizedEntities.TryGetValue(shortKey, out var listShort))
    matchedEntities = listShort;

if (matchedEntities != null)
{
    _serversWithEntities.Add(new ServerWithEntities
    {
        Server = server,
        Entities = matchedEntities
    });
}
else
{
    _serversNoMatch.Add(server);
}
// ... abajo ...