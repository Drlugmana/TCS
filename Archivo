// src/api/problems.js
// ===========================
// CONFIG FECHA
// - Si pones "YYYY-MM-DD" fuerza ese dÃ­a (00:00 a 23:59)
// - Si lo dejas null => usamos "Ãºltimas 24h" por defecto
export const ONLY_DATE = null;

// Por defecto: traer desde hace 1 dÃ­a hasta ahora
export const DEFAULT_RECENT_DAYS = 1;

// ===========================
// BASE DE LA API (desde .env)
const BASE = (import.meta.env.VITE_API_URL || "").replace(/\/+$/, "");
if (!BASE) throw new Error("Falta VITE_API_URL en .env (ej: https://xxxxx.brs.devtunnels.ms)");

const API = `${BASE}/api/Problems`;

// ===========================
// Helpers robustos
function cleanNull(v) {
  if (v === undefined || v === null) return null;
  if (typeof v === "string") {
    const t = v.trim();
    if (!t) return null;
    if (t.toLowerCase() === "null") return null;
    if (t.toLowerCase() === "undefined") return null;
    return t;
  }
  return v;
}

function parseDateToISO(v) {
  v = cleanNull(v);
  if (!v) return null;

  if (v instanceof Date) {
    const ms = v.getTime();
    return Number.isFinite(ms) ? v.toISOString() : null;
  }

  if (typeof v === "number") {
    const d = new Date(v);
    return Number.isFinite(d.getTime()) ? d.toISOString() : null;
  }

  if (typeof v === "string") {
    let s = v.trim();

    // "YYYY-MM-DD HH:mm:ss.fffffff" => "YYYY-MM-DDT..."
    if (/^\d{4}-\d{2}-\d{2}\s+\d/.test(s)) s = s.replace(" ", "T");

    const d = new Date(s);
    return Number.isFinite(d.getTime()) ? d.toISOString() : null;
  }

  return null;
}

function normalizeStatusValue(rawStatus, endTimeISO) {
  const s = cleanNull(rawStatus);
  const up = typeof s === "string" ? s.trim().toUpperCase() : "";

  if (up.includes("CLOSED") || up.includes("RESOLVED")) return "CLOSED";
  if (up.includes("OPEN")) return "OPEN";

  return endTimeISO ? "CLOSED" : "OPEN";
}

// ===========================
// Normalizador robusto
function normalize(list) {
  if (!Array.isArray(list)) return [];

  return list.map((p) => {
    const startRaw =
      p?.startTime ?? p?.startTimeUtc ?? p?.StartTime ?? p?.StartTimeUtc ?? p?.start_date ?? p?.Start ?? null;

    const endRaw =
      p?.endTime ?? p?.endTimeUtc ?? p?.EndTime ?? p?.EndTimeUtc ?? p?.end_date ?? p?.End ?? null;

    const startTime = parseDateToISO(startRaw);
    const endTime = parseDateToISO(endRaw);

    const jurisRaw =
      p?.jurisdiction?.label ??
      p?.jurisdiction?.name ??
      p?.Jurisdiction ??
      p?.jurisdiction ??
      p?.label ??
      "";

    const juris = typeof jurisRaw === "string" ? jurisRaw.trim().toUpperCase() : "";
    const isTcs =
      p?.jurisdiction?.isTcs ??
      (typeof juris === "string" ? (juris === "TCS" ? true : false) : false) ??
      false;

    const problemId = p?.problemId ?? p?.ProblemId ?? p?.displayId ?? p?.DisplayId ?? p?.id ?? p?.pid ?? "";
    const title = p?.title ?? p?.Title ?? p?.shortDescription ?? "(sin tÃ­tulo)";

    const severityLevel = p?.severityLevel ?? p?.SeverityLevel ?? p?.severity ?? "";
    const impactLevel = p?.impactLevel ?? p?.ImpactLevel ?? p?.impact ?? "";
    const environment = p?.environment ?? p?.Environment ?? p?.environmentName ?? p?.environmentText ?? "";

    const affectedCI =
      p?.affectedCI ??
      p?.AffectedCI ??
      p?.affectedEntities ??
      p?.affectedEntitiesList ??
      p?.AffectedEntities ??
      [];

    // status final siempre "OPEN"/"CLOSED"
    const status = normalizeStatusValue(p?.status ?? p?.Status ?? p?.state ?? p?.problemStatus, endTime);

    return {
      ...p,
      problemId,
      title,
      severityLevel,
      impactLevel,
      environment,
      affectedCI,
      status, // <-- CLAVE: siempre "OPEN" o "CLOSED"
      tenant: p?.tenant ?? p?.Tenant ?? p?.domain ?? "",
      label: isTcs ? "TCS" : "NO TCS",
      isTcs,
      startTime,
      endTime,
    };
  });
}

// ===========================
// Rango: dÃ­a completo "YYYY-MM-DD" (LOCAL)
function getDayRange(dateStr /* YYYY-MM-DD */) {
  const start = new Date(`${dateStr}T00:00:00`);
  const end = new Date(`${dateStr}T23:59:59.999`);
  return { startIso: start.toISOString(), endIso: end.toISOString() };
}

// Rango: Ãºltimas N dÃ­as (24h * N)
function getRecentRange(recentDays = 1) {
  const end = new Date();
  const start = new Date(end);
  start.setDate(end.getDate() - recentDays);
  return { startIso: start.toISOString(), endIso: end.toISOString() };
}

// ===========================
// Fetch de UNA pÃ¡gina con query-params
async function fetchPage({ pageNumber, pageSize, startIso, endIso }) {
  const params = new URLSearchParams();
  params.set("pageNumber", String(pageNumber));
  params.set("pageSize", String(pageSize));

  // Si tu backend los soporta, filtra desde SQL; si no, igual filtramos en cliente
  if (startIso) params.set("start", startIso);
  if (endIso) params.set("end", endIso);

  const url = `${API}?${params.toString()}`;
  const res = await fetch(url, { headers: { accept: "application/json" } });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status} en ${url}\n${txt}`);
  }

  const json = await res.json();

  const items = Array.isArray(json)
    ? json
    : json?.results || json?.items || json?.data || json?.value || [];

  return normalize(items);
}

// ===========================
// Fetch histÃ³rico con paginado + filtros (cliente)
export async function fetchAllProblems({
  onlyDate = ONLY_DATE,     // "YYYY-MM-DD" o null
  pageSize = 500,
  maxPages = 40,
  onBatch,

  tcsFilter,               // true | false | undefined
  statusFilter,            // "OPEN" | "CLOSED" | undefined
  environmentFilter,       // string parcial, ej: "Productivo"
  startIso,
  endIso,
  recentDays,              // ej: 1 => desde ayer hasta ahora
} = {}) {
  // 1) definir rango
  let range = { startIso, endIso };

  if (typeof onlyDate === "string") {
    range = getDayRange(onlyDate);
  } else if (!range.startIso || !range.endIso) {
    // por defecto: Ãºltimas 24h
    const r = getRecentRange(typeof recentDays === "number" ? recentDays : DEFAULT_RECENT_DAYS);
    range = { startIso: r.startIso, endIso: r.endIso };
  }

  // 2) paginar
  let all = [];

  for (let page = 1; page <= maxPages; page++) {
    const batch = await fetchPage({
      pageNumber: page,
      pageSize,
      startIso: range.startIso,
      endIso: range.endIso,
    });

    if (!batch.length) break;

    // 3) filtros robustos EN CLIENTE
    let filtered = batch;

    // filtro rango (por si backend ignora start/end)
    if (range.startIso || range.endIso) {
      const startMs = range.startIso ? new Date(range.startIso).getTime() : -Infinity;
      const endMs = range.endIso ? new Date(range.endIso).getTime() : Infinity;

      filtered = filtered.filter((x) => {
        const t = x.startTime ? new Date(x.startTime).getTime() : null;
        if (!t || !Number.isFinite(t)) return false;
        return t >= startMs && t <= endMs;
      });
    }

    if (typeof tcsFilter === "boolean") {
      filtered = filtered.filter((x) => x.isTcs === tcsFilter);
    }

    if (statusFilter) {
      const want = String(statusFilter).toUpperCase();
      filtered = filtered.filter((x) => String(x.status || "").toUpperCase() === want);
    }

    if (environmentFilter) {
      const want = String(environmentFilter).toUpperCase();
      filtered = filtered.filter((x) => String(x.environment || "").toUpperCase().includes(want));
    }

    if (onBatch) onBatch(filtered);
    all = all.concat(filtered);

    if (batch.length < pageSize) break;
  }

  // 4) ordenar por mÃ¡s reciente
  all.sort((a, b) => {
    const da = a.startTime ? new Date(a.startTime).getTime() : 0;
    const db = b.startTime ? new Date(b.startTime).getTime() : 0;
    return db - da;
  });

  return all;
}

// ===========================
// Conveniencias TCS / NO TCS (Ãºltimas 24h por defecto)
export const fetchTcsProblemsDay = (dateStr = ONLY_DATE, opts = {}) =>
  fetchAllProblems({ onlyDate: dateStr, tcsFilter: true, ...opts });

export const fetchNotTcsProblemsDay = (dateStr = ONLY_DATE, opts = {}) =>
  fetchAllProblems({ onlyDate: dateStr, tcsFilter: false, ...opts });

// âœ… Alias para que NO te falle el import
export const fetchNoTcsProblemsDay = fetchNotTcsProblemsDay;

export const fetchTcsAllHistory = (opts = {}) =>
  fetchAllProblems({ onlyDate: null, tcsFilter: true, recentDays: DEFAULT_RECENT_DAYS, ...opts });

export const fetchNotTcsAllHistory = (opts = {}) =>
  fetchAllProblems({ onlyDate: null, tcsFilter: false, recentDays: DEFAULT_RECENT_DAYS, ...opts });

// Helper: solo recientes N dÃ­as
export const fetchRecentProblems = (recentDays = 1, opts = {}) =>
  fetchAllProblems({ onlyDate: null, recentDays, ...opts });


------1122


import React, { useEffect, useMemo, useState } from "react";
import { useBiaCatalog } from "../context/BiaCatalogContext";
import {
  getSlaMinutes,
  getColorByPercent,
  calcularCriticidadDetallada,
  getButtonColorByPercent,
} from "../utils/slaUtils";

// ==== Normaliza estado OPEN/CLOSED (con fallback por endTime) ====
function normalizeStatus(p) {
  const raw = p?.status ?? p?.Status ?? p?.problemStatus ?? "";
  const s = String(raw).trim().toUpperCase();

  if (!s) return p?.endTime ? "CLOSED" : "OPEN";
  if (s.includes("CLOSED") || s.includes("RESOLVED")) return "CLOSED";
  if (s.includes("OPEN")) return "OPEN";
  return p?.endTime ? "CLOSED" : "OPEN";
}

// === Traduce towerKey a icono correspondiente ===
function towerToIconPath(towerKey) {
  if (!towerKey) return null;
  const key = String(towerKey).toLowerCase();

  if (key.includes("wintel") || key.includes("windows")) return "/icons/towers/wiltel1.svg";
  if (key.includes("bdd") || key.includes("base de datos") || key.includes("database") || key.includes("bd"))
    return "/icons/towers/Base.svg";
  if (key.includes("unix") || key.includes("aix") || key.includes("linux")) return "/icons/towers/unix.svg";

  return null;
}

// === Componente principal ===
export default function ProblemCard({ problem, username }) {
  const {
    title,
    severityLevel,
    impactLevel,
    startTime,
    endTime,
    environment,
    affectedCI = [],
    tenant,
    problemId,
  } = problem;

  const { get: catalogGet } = useBiaCatalog();

  // âœ… Estado Ãºnico (normalizado)
  const status = useMemo(() => normalizeStatus(problem), [problem]);

  // Buscar coincidencia con catÃ¡logo
  const hitFromCatalog = useMemo(() => {
    for (const ci of affectedCI || []) {
      const name = ci?.name || ci?.Nombre;
      const hit = name ? catalogGet(name) : null;
      if (hit) return hit;
    }
    return null;
  }, [affectedCI, catalogGet]);

  const towerIcon = towerToIconPath(hitFromCatalog?.tower);
  const { criticidad } = calcularCriticidadDetallada(problem, {
    catalogLookup: (ciName) => catalogGet(ciName),
  });

  // === SLA / colores ===
  const slaMinutes = getSlaMinutes(criticidad);

  const start = useMemo(() => new Date(startTime), [startTime]);
  const end = useMemo(() => (endTime ? new Date(endTime) : null), [endTime]);

  const [now, setNow] = useState(() => new Date());

  // âœ… Solo corre si estÃ¡ OPEN
  useEffect(() => {
    if (status === "CLOSED") {
      setNow(end || start);
      return;
    }
    const interval = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(interval);
  }, [status, end, start]);

  const effectiveNow = status === "CLOSED" ? (end || now) : now;

  const elapsedMinutes = useMemo(() => {
    const diff = (effectiveNow - start) / 60000;
    return Number.isFinite(diff) ? diff : 0;
  }, [effectiveNow, start]);

  const remainingMinutes = Math.max(slaMinutes - elapsedMinutes, 0);
  const percentRemaining = slaMinutes > 0 ? Math.max((remainingMinutes / slaMinutes) * 100, 0) : 0;

  const bgColor = getColorByPercent(percentRemaining);
  const buttonColor = getButtonColorByPercent(percentRemaining);

  const formatTime = (minutes) => {
    const totalSeconds = Math.floor(minutes * 60);
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    return `${String(hrs).padStart(2, "0")}:${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
  };

  const uniqueNames = [...new Set(affectedCI.map((ci) => ci?.name).filter(Boolean))];
  const equipos = uniqueNames.join(", ");
  const isDisabled = !username;
  const dynatraceUrl = `https://${tenant}.live.dynatrace.com/#problems/problemdetails;pid=${problemId}`;

  return (
    <div
      style={{
        display: "flex",
        justifyContent: "space-between",
        alignItems: "center",
        borderRadius: "12px",
        padding: "1rem 1.5rem",
        marginBottom: "1rem",
        backgroundColor: bgColor,
        boxShadow: "0 4px 10px rgba(0,0,0,.1)",
        opacity: status === "CLOSED" ? 0.9 : 1,
      }}
    >
      {/* INFO A LA IZQUIERDA / ICONOS A LA DERECHA */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          padding: "1rem",
          gap: "1rem",
        }}
      >
        {/* COLUMNA IZQUIERDA: INFORMACIÃ“N */}
        <div style={{ flex: 1, paddingRight: "1rem" }}>
          <h3 style={{ margin: 0, fontSize: "1.6rem", fontWeight: "bold" }}>{title}</h3>

          <p style={{ fontSize: "1.2rem" }}>
            <strong>Severidad Dynatrace:</strong> {severityLevel}
          </p>

          <p style={{ fontSize: "1.2rem" }}>
            <strong>Impacto:</strong> {impactLevel}
          </p>

          <p style={{ fontSize: "1.2rem" }}>
            <strong>Inicio:</strong> {start.toLocaleString()}
          </p>

          {/* âœ… FIX: estado REAL */}
          <p style={{ fontSize: "1.2rem" }}>
            <strong>Estado:</strong> {status}
          </p>

          <p style={{ fontSize: "1.2rem" }}>
            <strong>Criticidad (BIA):</strong> {criticidad}
          </p>

          <p style={{ fontSize: "1.2rem" }}>
            <strong>Equipos afectados:</strong> <small>{equipos}</small>
          </p>
        </div>

        {/* COLUMNA CENTRAL: ICONOS */}
        <div
          style={{
            display: "flex",
            justifyContent: "center",
            alignItems: "center",
            gap: "1rem",
            flexShrink: 0,
            minWidth: "200px",
          }}
        >
          {(() => {
            const size = 110;
            return (
              <>
                <img src={`/severidad${criticidad}.svg`} width={size} height={size} title={`Criticidad ${criticidad}`} />

                <img
                  src={String(environment).toUpperCase() === "PRODUCTIVO" ? "/icon-productivo.svg" : "/icon-noproductivo.svg"}
                  width={size}
                  height={size}
                  title={environment}
                />

                {towerIcon && (
                  <img
                    src={towerIcon}
                    alt="tower"
                    width={size}
                    height={size}
                    title={hitFromCatalog?.towerRaw || hitFromCatalog?.tower}
                  />
                )}
              </>
            );
          })()}
        </div>
      </div>

      {/* TEMPORIZADOR Y BOTÃ“N */}
      <div style={{ textAlign: "center" }}>
        <div style={{ fontSize: "2rem", fontWeight: "bold" }}>
          {formatTime(remainingMinutes)}
        </div>

        <button
          disabled={isDisabled}
          onClick={() => window.open(dynatraceUrl, "_blank")}
          style={{
            marginTop: ".5rem",
            padding: ".4rem 1rem",
            fontSize: ".9rem",
            fontWeight: "bold",
            color: "#fff",
            backgroundColor: isDisabled ? "#b0b0b0" : status === "CLOSED" ? "#6b7280" : buttonColor,
            border: "none",
            borderRadius: "8px",
            cursor: isDisabled ? "not-allowed" : "pointer",
          }}
        >
          Revisar problema
        </button>
      </div>
    </div>
  );
}

------12


import React, { useEffect, useMemo, useState } from "react";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";
import { fetchTcsProblemsDay, ONLY_DATE, DEFAULT_RECENT_DAYS } from "../api/problems";

// ========= helpers (idÃ©ntico enfoque que ya venÃ­as usando) =========
function detectEnvironmentRaw(problem) {
  const raw =
    problem?.environmentIcon ||
    problem?.environmentText ||
    problem?.environment ||
    problem?.entorno ||
    problem?.env ||
    "";
  return String(raw).toLowerCase().trim();
}

function isProd(problem) {
  const env = detectEnvironmentRaw(problem);

  // evita falso positivo por "productivo" dentro de "noproductivo"
  if (env.includes("icon-noproductivo") || env.includes("no-productivo") || env.includes("noproductivo")) return false;
  if (env.includes("icon-productivo")) return true;

  const nonProdRegex =
    /\b(np|nprod|qa|v|dev|desa|desarrollo|test|testing|stg|stage|staging|uat|preprod|pre-prod|pre\s*prod|preprodu)\b/i;
  if (nonProdRegex.test(env)) return false;

  if (/\b(productivo|producci[oÃ³]n|production)\b/i.test(env)) return true;
  if (/\bprod\b/i.test(env) || /^prod[\w-]*/i.test(env)) return true;

  return false; // desconocido => no productivo
}

function normalizeStatus(p) {
  const raw = p?.status ?? p?.Status ?? p?.problemStatus ?? "";
  const s = String(raw).trim().toUpperCase();
  if (!s) return p?.endTime ? "CLOSED" : "OPEN";
  if (s.includes("CLOSED") || s.includes("RESOLVED")) return "CLOSED";
  if (s.includes("OPEN")) return "OPEN";
  return p?.endTime ? "CLOSED" : "OPEN";
}

export default function TCSProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");

  // pestaÃ±as
  const [envTab, setEnvTab] = useState("prod");      // 'prod' | 'nonprod'
  const [statusTab, setStatusTab] = useState("open"); // 'open' | 'closed'

  // ====== cargar (y refrescar) ======
  useEffect(() => {
    let mounted = true;

    async function load() {
      try {
        setError(null);
        setLoading(true);

        // ðŸ”¥ SOLO desde hace 1 dÃ­a hasta ahora (y si ONLY_DATE viene con dÃ­a fijo, tambiÃ©n funciona)
        const data = await fetchTcsProblemsDay(ONLY_DATE, {
          recentDays: DEFAULT_RECENT_DAYS,
          pageSize: 500,
          maxPages: 40,
        });

        if (!mounted) return;

        // ordenado por startTime desc
        const sorted = [...data].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        setProblems(sorted);
      } catch (e) {
        if (!mounted) return;
        setError(e?.message || String(e));
      } finally {
        if (mounted) setLoading(false);
      }
    }

    load();

    // âœ… â€œtiempo realâ€: refresca cada 30s
    const t = setInterval(load, 30000);

    return () => {
      mounted = false;
      clearInterval(t);
    };
  }, []);

  // ====== listas por pestaÃ±as ======
  const prodList = useMemo(() => problems.filter(isProd), [problems]);
  const nonProdList = useMemo(() => problems.filter((p) => !isProd(p)), [problems]);

  const envList = envTab === "prod" ? prodList : nonProdList;

  const openList = useMemo(() => envList.filter((p) => normalizeStatus(p) === "OPEN"), [envList]);
  const closedList = useMemo(() => envList.filter((p) => normalizeStatus(p) === "CLOSED"), [envList]);

  const selectedList = statusTab === "open" ? openList : closedList;

  if (error) return <h2 style={{ color: "red" }}>Error: {error}</h2>;

  return (
    <div style={{ maxWidth: "900px", margin: "0 auto", padding: "1rem" }}>
      <h2>
        Problemas TCS <span>({problems.length})</span>
      </h2>

      <UsernameInput value={username} onChange={setUsername} />

      {!loading && problems.length === 0 && (
        <p>No hay problemas TCS en el rango (Ãºltimas 24h / dÃ­a seleccionado).</p>
      )}

      {/* Tabs de ambiente */}
      <div style={{ display: "flex", gap: ".5rem", margin: "1rem 0 .5rem" }}>
        <button
          onClick={() => setEnvTab("prod")}
          disabled={envTab === "prod"}
          style={{
            padding: ".5rem 1rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: envTab === "prod" ? "#dbeafe" : "#f8fafc",
            fontWeight: envTab === "prod" ? "bold" : "normal",
            cursor: envTab === "prod" ? "default" : "pointer",
          }}
        >
          Productivo ({prodList.length})
        </button>

        <button
          onClick={() => setEnvTab("nonprod")}
          disabled={envTab === "nonprod"}
          style={{
            padding: ".5rem 1rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: envTab === "nonprod" ? "#fef3c7" : "#f8fafc",
            fontWeight: envTab === "nonprod" ? "bold" : "normal",
            cursor: envTab === "nonprod" ? "default" : "pointer",
          }}
        >
          No Productivo ({nonProdList.length})
        </button>
      </div>

      {/* Subtabs de estado */}
      <div style={{ display: "flex", gap: ".5rem", margin: ".25rem 0 1rem" }}>
        <button
          onClick={() => setStatusTab("open")}
          disabled={statusTab === "open"}
          style={{
            padding: ".35rem .9rem",
            borderRadius: "999px",
            border: "1px solid #e5e7eb",
            background: statusTab === "open" ? "#fde68a" : "#ffffff",
            fontWeight: statusTab === "open" ? "bold" : "normal",
            cursor: statusTab === "open" ? "default" : "pointer",
          }}
        >
          Abiertas ({openList.length})
        </button>

        <button
          onClick={() => setStatusTab("closed")}
          disabled={statusTab === "closed"}
          style={{
            padding: ".35rem .9rem",
            borderRadius: "999px",
            border: "1px solid #e5e7eb",
            background: statusTab === "closed" ? "#bbf7d0" : "#ffffff",
            fontWeight: statusTab === "closed" ? "bold" : "normal",
            cursor: statusTab === "closed" ? "default" : "pointer",
          }}
        >
          Cerradas ({closedList.length})
        </button>
      </div>

      {loading && <p>Cargando problemas...</p>}

      {selectedList.map((p) => (
        <ProblemCard key={p.problemId || p.pid || p.id} problem={p} username={username} />
      ))}
    </div>
  );
}

---///-12


import React, { useEffect, useMemo, useState } from "react";
import ProblemCard from "../components/ProblemCard";
import UsernameInput from "../components/UsernameInput";
import { fetchNoTcsProblemsDay, ONLY_DATE, DEFAULT_RECENT_DAYS } from "../api/problems";

// ========= helpers =========
function detectEnvironmentRaw(problem) {
  const raw =
    problem?.environmentIcon ||
    problem?.environmentText ||
    problem?.environment ||
    problem?.entorno ||
    problem?.env ||
    "";
  return String(raw).toLowerCase().trim();
}

function isProd(problem) {
  const env = detectEnvironmentRaw(problem);

  if (env.includes("icon-noproductivo") || env.includes("no-productivo") || env.includes("noproductivo")) return false;
  if (env.includes("icon-productivo")) return true;

  const nonProdRegex =
    /\b(np|nprod|qa|v|dev|desa|desarrollo|test|testing|stg|stage|staging|uat|preprod|pre-prod|pre\s*prod|preprodu)\b/i;
  if (nonProdRegex.test(env)) return false;

  if (/\b(productivo|producci[oÃ³]n|production)\b/i.test(env)) return true;
  if (/\bprod\b/i.test(env) || /^prod[\w-]*/i.test(env)) return true;

  return false;
}

function normalizeStatus(p) {
  const raw = p?.status ?? p?.Status ?? p?.problemStatus ?? "";
  const s = String(raw).trim().toUpperCase();
  if (!s) return p?.endTime ? "CLOSED" : "OPEN";
  if (s.includes("CLOSED") || s.includes("RESOLVED")) return "CLOSED";
  if (s.includes("OPEN")) return "OPEN";
  return p?.endTime ? "CLOSED" : "OPEN";
}

export default function OtherProblems() {
  const [problems, setProblems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [username, setUsername] = useState("");

  const [envTab, setEnvTab] = useState("prod");       // 'prod' | 'nonprod'
  const [statusTab, setStatusTab] = useState("open"); // 'open' | 'closed'

  useEffect(() => {
    let mounted = true;

    async function load() {
      try {
        setError(null);
        setLoading(true);

        const data = await fetchNoTcsProblemsDay(ONLY_DATE, {
          recentDays: DEFAULT_RECENT_DAYS,
          pageSize: 500,
          maxPages: 40,
        });

        if (!mounted) return;

        const sorted = [...data].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        setProblems(sorted);
      } catch (e) {
        if (!mounted) return;
        setError(e?.message || String(e));
      } finally {
        if (mounted) setLoading(false);
      }
    }

    load();
    const t = setInterval(load, 30000);

    return () => {
      mounted = false;
      clearInterval(t);
    };
  }, []);

  const prodList = useMemo(() => problems.filter(isProd), [problems]);
  const nonProdList = useMemo(() => problems.filter((p) => !isProd(p)), [problems]);

  const envList = envTab === "prod" ? prodList : nonProdList;

  const openList = useMemo(() => envList.filter((p) => normalizeStatus(p) === "OPEN"), [envList]);
  const closedList = useMemo(() => envList.filter((p) => normalizeStatus(p) === "CLOSED"), [envList]);

  const selectedList = statusTab === "open" ? openList : closedList;

  if (error) return <h2 style={{ color: "red" }}>Error: {error}</h2>;

  return (
    <div style={{ maxWidth: "900px", margin: "0 auto", padding: "1rem" }}>
      <h2>
        Problemas Otros <span>({problems.length})</span>
      </h2>

      <UsernameInput value={username} onChange={setUsername} />

      {!loading && problems.length === 0 && (
        <p>No hay problemas NO TCS en el rango (Ãºltimas 24h / dÃ­a seleccionado).</p>
      )}

      {/* Tabs de ambiente */}
      <div style={{ display: "flex", gap: ".5rem", margin: "1rem 0 .5rem" }}>
        <button
          onClick={() => setEnvTab("prod")}
          disabled={envTab === "prod"}
          style={{
            padding: ".5rem 1rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: envTab === "prod" ? "#dbeafe" : "#f8fafc",
            fontWeight: envTab === "prod" ? "bold" : "normal",
            cursor: envTab === "prod" ? "default" : "pointer",
          }}
        >
          Productivo ({prodList.length})
        </button>

        <button
          onClick={() => setEnvTab("nonprod")}
          disabled={envTab === "nonprod"}
          style={{
            padding: ".5rem 1rem",
            borderRadius: "999px",
            border: "1px solid #cbd5e1",
            background: envTab === "nonprod" ? "#fef3c7" : "#f8fafc",
            fontWeight: envTab === "nonprod" ? "bold" : "normal",
            cursor: envTab === "nonprod" ? "default" : "pointer",
          }}
        >
          No Productivo ({nonProdList.length})
        </button>
      </div>

      {/* Subtabs de estado */}
      <div style={{ display: "flex", gap: ".5rem", margin: ".25rem 0 1rem" }}>
        <button
          onClick={() => setStatusTab("open")}
          disabled={statusTab === "open"}
          style={{
            padding: ".35rem .9rem",
            borderRadius: "999px",
            border: "1px solid #e5e7eb",
            background: statusTab === "open" ? "#fde68a" : "#ffffff",
            fontWeight: statusTab === "open" ? "bold" : "normal",
            cursor: statusTab === "open" ? "default" : "pointer",
          }}
        >
          Abiertas ({openList.length})
        </button>

        <button
          onClick={() => setStatusTab("closed")}
          disabled={statusTab === "closed"}
          style={{
            padding: ".35rem .9rem",
            borderRadius: "999px",
            border: "1px solid #e5e7eb",
            background: statusTab === "closed" ? "#bbf7d0" : "#ffffff",
            fontWeight: statusTab === "closed" ? "bold" : "normal",
            cursor: statusTab === "closed" ? "default" : "pointer",
          }}
        >
          Cerradas ({closedList.length})
        </button>
      </div>

      {loading && <p>Cargando problemas...</p>}

      {selectedList.map((p) => (
        <ProblemCard key={p.problemId || p.pid || p.id} problem={p} username={username} />
      ))}
    </div>
  );
}