// Program.cs
using System.Data;
using Microsoft.ML;
using Microsoft.ML.Data;
using DynatraceJurisdictionModelTraining.Models;
using ExcelDataReader;
using System.Text;

class Program
{
    // Rutas (ajusta los nombres/ubicaciones a los tuyos)
    static readonly string _dataPath   = Path.Combine(AppContext.BaseDirectory, "Data", "CatalogoEventosNov2025.xlsx");
    static readonly string _modelPath  = Path.Combine(AppContext.BaseDirectory, "ML",   "jurisdiction_model.zip");

    static MLContext _ml = new MLContext(seed: 42);

    static async Task Main(string[] args)
    {
        // 1) Cargar catálogo desde Excel -> IDataView (train/test)
        var split = LoadCatalogFromExcel(_dataPath, testFraction: 0.2);

        // 2) Definir pipeline: texto -> features -> clasificador binario
        var pipeline =
            _ml.Transforms.Text.FeaturizeText("ProblemTitleFeaturized", nameof(IncidentData.ProblemTitle))
              .Append(_ml.Transforms.Concatenate("Features", "ProblemTitleFeaturized"))
              .Append(_ml.Transforms.NormalizeMinMax("Features"))
              .Append(_ml.BinaryClassification.Trainers.SdcaLogisticRegression(
                    labelColumnName: nameof(IncidentData.EsTCS),
                    featureColumnName: "Features"));

        // 3) Entrenar
        Console.WriteLine("Entrenando modelo...");
        var model = pipeline.Fit(split.TrainSet);
        Console.WriteLine("Entrenamiento finalizado.");

        // 4) Evaluar
        var predictions = model.Transform(split.TestSet);
        var metrics = _ml.BinaryClassification.Evaluate(
            data: predictions,
            labelColumnName: nameof(IncidentData.EsTCS),
            scoreColumnName: "Score",
            probabilityColumnName: "Probability");

        Console.WriteLine($"AUC: {metrics.AreaUnderRocCurve:F4} | Acc: {metrics.Accuracy:P2} | F1: {metrics.F1Score:F4}");

        // 5) Guardar modelo
        Directory.CreateDirectory(Path.GetDirectoryName(_modelPath)!);
        _ml.Model.Save(model, split.TrainSet.Schema, _modelPath);
        Console.WriteLine($"Modelo guardado en: {_modelPath}");

        // 6) Ejemplo de predicción
        var engine = _ml.Model.CreatePredictionEngine<IncidentData, IncidentPrediction>(model);
        var sample = new IncidentData { ProblemTitle = "Alerta CPU HOST en prod DB2 – umbral superado" };
        var pred = engine.Predict(sample);

        Console.WriteLine($"Predicción: {(pred.PredictedEsTCS ? "ES TCS" : "NO ES TCS")} | Prob: {pred.Probability:P2}");
    }

    // Lee el catálogo y mapea columnas: A = Problem Title, C = ALCANCE (“SI TCS”/“NO TCS”)
    static TrainTestData LoadCatalogFromExcel(string excelPath, double testFraction)
    {
        Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);

        using var stream = File.Open(excelPath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite);
        var config = new ExcelDataSetConfiguration
        {
            ConfigureDataTable = _ => new ExcelDataTableConfiguration { UseHeaderRow = true }
        };

        using var reader = ExcelReaderFactory.CreateReader(stream);
        var result = reader.AsDataSet(config);
        var table = result.Tables[0]; // primera hoja

        var rows = table.Rows.Cast<DataRow>();

        // Nombres exactos de columnas (ajústalos si tu hoja usa otros):
        const string COL_TITLE   = "Problem Title"; // Columna A
        const string COL_ALCANCE = "ALCANCE";       // Columna C

        var data = rows
            .Where(r => !IsNullOrWhiteSpace(r, COL_TITLE) && !IsNullOrWhiteSpace(r, COL_ALCANCE))
            .Select(r => new IncidentData
            {
                ProblemTitle = r[COL_TITLE].ToString()!.Trim(),
                EsTCS        = ParseAlcanceToBool(r[COL_ALCANCE].ToString()!)
            })
            .ToList();

        var dv = _ml.Data.LoadFromEnumerable(data);
        return _ml.Data.TrainTestSplit(dv, testFraction: testFraction);
    }

    static bool ParseAlcanceToBool(string raw)
    {
        // Normaliza y soporta variantes
        var v = (raw ?? "").Trim().ToUpperInvariant();
        if (v.Contains("SI TCS") || v == "TCS" || v == "SI")
            return true;
        if (v.Contains("NO TCS") || v == "NO TCS" || v == "NO")
            return false;

        // Fallback: considera NO TCS si es desconocido
        return false;
    }

    static bool IsNullOrWhiteSpace(DataRow r, string col)
        => !r.Table.Columns.Contains(col) || r[col] == null || string.IsNullOrWhiteSpace(r[col].ToString());
}