// ↓↓↓ (dos líneas antes iguales)
var normalizedEntities = new ConcurrentDictionary<string, List<EntitySchema>>(StringComparer.OrdinalIgnoreCase);

foreach (var kvp in entitiesList)
{
    // Key completa tal cual llega de Dynatrace (FQDN si lo hay)
    var fullKey = (kvp.Key ?? string.Empty).Trim();
    if (!string.IsNullOrWhiteSpace(fullKey))
        normalizedEntities.AddOrUpdate(fullKey, _ => kvp.Value, (_, existing) => existing);

    // Key corta (sin dominio) para match flexible
    var shortKey = fullKey.Split('.')[0];
    if (!string.IsNullOrWhiteSpace(shortKey))
        normalizedEntities.AddOrUpdate(shortKey, _ => kvp.Value, (_, existing) => existing);
}
// ↑↑↑ (dos líneas después iguales)