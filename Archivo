// ... arriba ...
var server = serverWithEntities.Server;
string originalName = server?.Name ?? "";
bool serverHasDomain = originalName.Contains('.');

int Score(EntitySchema e)
{
    int s = 0;

    // Coincidencia exacta con el nombre tal cual llega de CMDB/Dynatrace
    if (!string.IsNullOrWhiteSpace(e.DisplayName) &&
        string.Equals(e.DisplayName, originalName, StringComparison.OrdinalIgnoreCase)) s += 5000;

    // Si el server trae dominio, favorece entidades con FQDN
    if (serverHasDomain && (e.DisplayName?.Contains('.') ?? false)) s += 500;

    if (string.Equals(e.Type, "HOST", StringComparison.OrdinalIgnoreCase)) s += 1000;
    if (!string.IsNullOrWhiteSpace(e.Properties?.MonitoringMode)) s += 200;
    if (string.Equals(e.Properties?.MonitoringMode, "INFRASTRUCTURE", StringComparison.OrdinalIgnoreCase)) s += 100;

    if (!string.IsNullOrWhiteSpace(e.Properties?.OneAgentCustomHostName)) s += 10;
    if (!string.IsNullOrWhiteSpace(e.Properties?.DetectedName)) s += 10;
    if (e.Properties?.LogicalCpuCores != null) s += 5;
    if (e.Properties?.PhysicalMemory != null) s += 5;
    if ((e.ManagementZones?.Count ?? 0) > 0) s += 3;
    if ((e.Tags?.Count ?? 0) > 0) s += 3;

    s += (int)(e.LastSeen - DateTime.MinValue).TotalSeconds / 100000;
    return s;
}
// ... abajo ...
